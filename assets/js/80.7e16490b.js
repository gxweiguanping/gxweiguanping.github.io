(window.webpackJsonp=window.webpackJsonp||[]).push([[80],{410:function(t,e,s){"use strict";s.r(e);var a=s(8),r=Object(a.a)({},(function(){var t=this,e=t._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"分布式事务问题"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#分布式事务问题"}},[t._v("#")]),t._v(" 分布式事务问题")]),t._v(" "),e("h2",{attrs:{id:"本地事务"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#本地事务"}},[t._v("#")]),t._v(" 本地事务")]),t._v(" "),e("p",[t._v("本地事务，也被称为"),e("a",{attrs:{href:"https://so.csdn.net/so/search?q=%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1&spm=1001.2101.3001.7020",target:"_blank",rel:"noopener noreferrer"}},[t._v("数据库事务"),e("OutboundLink")],1),t._v("或传统事务，也就是传统的"),e("strong",[t._v("单机事务")]),t._v("。它主要指的是在一个数据库连接中执行的一组sql语句，这组sql语句在一个事务中要么一起成功，要么一起失败。在传统数据库事务中，必须要满足四个原则：")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/studentgitee/note-picture/raw/master/1688921793443-12433588-ed53-42df-b287-bca344acecf9.jpg",alt:"img"}})]),t._v(" "),e("h2",{attrs:{id:"分布式事务"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#分布式事务"}},[t._v("#")]),t._v(" 分布式事务")]),t._v(" "),e("p",[t._v("分布式事务，是一个在分布式系统环境下由不同的服务之间通过网络远程协作完成的操作，就是指不是在单个服务或单个数据库架构下，产生的事务，例如：")]),t._v(" "),e("ul",[e("li",[t._v("跨数据源的分布式事务")]),t._v(" "),e("li",[t._v("跨服务的分布式事务")]),t._v(" "),e("li",[t._v("综合情况")])]),t._v(" "),e("p",[t._v("在数据库水平拆分、服务垂直拆分之后，一个业务操作通常要跨多个数据库、服务才能完成。例如电商行业中比较常见的下单付款案例，包括下面几个行为：")]),t._v(" "),e("ul",[e("li",[e("p",[t._v("创建新订单")])]),t._v(" "),e("li",[e("p",[t._v("扣减商品库存")])]),t._v(" "),e("li",[e("p",[t._v("从用户账户余额扣除金额")])])]),t._v(" "),e("p",[t._v("完成上面的操作需要访问三个不同的微服务和三个不同的数据库。\n"),e("img",{attrs:{src:"https://gitee.com/studentgitee/note-picture/raw/master/1688921793531-603b6b3d-88ec-4053-820c-57047a194598.jpg",alt:"img"}})]),t._v(" "),e("p",[t._v("订单的创建、库存的扣减、账户扣款在每一个服务和数据库内是一个本地事务，可以保证ACID原则。")]),t._v(" "),e("p",[t._v('但是当我们把三件事情看做一个"业务"，要满足保证“业务”的原子性，要么所有操作全部成功，要么全部失败，不允许出现部分成功部分失败的现象，这就是分布式系统下的事务了。')]),t._v(" "),e("p",[t._v("此时ACID难以满足，这是分布式事务要解决的问题")]),t._v(" "),e("h2",{attrs:{id:"演示分布式事务问题"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#演示分布式事务问题"}},[t._v("#")]),t._v(" 演示分布式事务问题")]),t._v(" "),e("p",[t._v("我们通过一个案例来演示分布式事务的问题：")]),t._v(" "),e("p",[t._v("资源链接")]),t._v(" "),e("blockquote",[e("p",[t._v("链接：https://pan.baidu.com/s/1tSYc5F-SlPu-ZjgxYa_6PQ?pwd=4w9u\n提取码：4w9u")])]),t._v(" "),e("p",[t._v("1）"),e("strong",[t._v("创建数据库，名为seata_demo，然后导入资料提供的SQL文件：")])]),t._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/studentgitee/note-picture/raw/master/image-20240417134400049.png",alt:"image-20240417134400049"}})]),t._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/studentgitee/note-picture/raw/master/image-20240417134420945.png",alt:"image-20240417134420945"}})]),t._v(" "),e("p",[t._v("微服务结构如下：")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/studentgitee/note-picture/raw/master/image-20240417125536530.png",alt:"image-20240417125536530"}})]),t._v(" "),e("p",[t._v("其中：")]),t._v(" "),e("p",[t._v("seata-demo：父工程，负责管理项目依赖")]),t._v(" "),e("ul",[e("li",[e("p",[t._v("account-service：账户服务，负责管理用户的资金账户。提供扣减余额的接口")])]),t._v(" "),e("li",[e("p",[t._v("storage-service：库存服务，负责管理商品库存。提供扣减库存的接口")])]),t._v(" "),e("li",[e("p",[t._v("order-service：订单服务，负责管理订单。创建订单时，需要调用account-service和storage-service")])])]),t._v(" "),e("p",[e("strong",[t._v("3）修改数据库")])]),t._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/studentgitee/note-picture/raw/master/g40.jpg",alt:"g40"}})]),t._v(" "),e("p",[e("strong",[t._v("4）启动nacos和所有微服务")])]),t._v(" "),e("p",[e("strong",[t._v("这里提供一个本地的nacos服务，找到bin目录在导航栏进入cmd窗口敲运行命令运行就可以了")])]),t._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("startup.cmd "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-m")]),t._v(" standalone\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://gitee.com/studentgitee/note-picture/raw/master/image-20240417134438615.png",alt:"image-20240417134438615"}})]),t._v(" "),e("p",[e("strong",[e("img",{attrs:{src:"https://gitee.com/studentgitee/note-picture/raw/master/image-20240417125924250.png",alt:"image-20240417125924250"}})])]),t._v(" "),e("p",[t._v("然后把导入项目的微服务全部运行")]),t._v(" "),e("p",[e("strong",[t._v("5）测试下单功能，发出Post请求：")])]),t._v(" "),e("p",[t._v("请求如下：")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("curl --location --request POST 'http://localhost:8082/order?userId=user202103032042012&commodityCode=100202003032041&count=2&money=200'\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("p",[t._v("如图：")]),t._v(" "),e("p",[t._v("可以将上面的curl导入到postman或者apifox")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/studentgitee/note-picture/raw/master/image-20240417130041596.png",alt:"image-20240417130041596"}})]),t._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/studentgitee/note-picture/raw/master/image-20240417130028594.png",alt:"image-20240417130028594"}})]),t._v(" "),e("p",[t._v("6）打开数据库，看一下order_tbl表是否有一条订单数据、account_tbl表的money字段是否从1000变成800、storage_tbl表的count是否从10变成8")]),t._v(" "),e("p",[t._v("是的话就表示上面的操作是正常完成的，增加了一条订单、扣了200余额、减了2个库存")]),t._v(" "),e("p",[t._v("7） 模拟失败的情况。")]),t._v(" "),e("p",[t._v("在postman软件发送如下POST请求，我们库存现在只有8，但是发的是10，按理来说会失败，也就是库存扣除失败，从而金额扣除失败、订单增加失败，那是不是这样呢?")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("http://localhost:8082/order?userId=user202103032042012&commodityCode=100202003032041&count=10&money=200\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://gitee.com/studentgitee/note-picture/raw/master/g44.jpg",alt:"g44"}})]),t._v(" "),e("p",[e("strong",[t._v("经过查询数据库，我们发现余额表依旧是扣除了200，但是订单表和库存表没有变化，也就是此次操作出现了问题，我们莫名其妙扣除了用户200元，此时的事务并不是一致的，这就是分布式事务问题")])]),t._v(" "),e("p",[t._v("8）上面的分布式事务问题的流程图如下")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://gitee.com/studentgitee/note-picture/raw/master/g45.jpg",alt:"g45"}})])])}),[],!1,null,null,null);e.default=r.exports}}]);