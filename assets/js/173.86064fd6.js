(window.webpackJsonp=window.webpackJsonp||[]).push([[173],{504:function(a,s,t){"use strict";t.r(s);var e=t(8),r=Object(e.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"kafka历史数据清理策略以及配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#kafka历史数据清理策略以及配置"}},[a._v("#")]),a._v(" kafka历史数据清理策略以及配置")]),a._v(" "),s("h2",{attrs:{id:"关于kafka的日志"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#关于kafka的日志"}},[a._v("#")]),a._v(" 关于Kafka的日志")]),a._v(" "),s("p",[a._v("日志的英语是“log”，但Kafka的数据文件也被称为log，所以很多时候会造成一定的歧义。在Kafka中，日志分为两种：")]),a._v(" "),s("ul",[s("li",[a._v("数据日志")]),a._v(" "),s("li",[a._v("操作日志")])]),a._v(" "),s("h2",{attrs:{id:"kafka-历史数据清理策略"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#kafka-历史数据清理策略"}},[a._v("#")]),a._v(" Kafka 历史数据清理策略")]),a._v(" "),s("h3",{attrs:{id:"基于时间的保留策略"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#基于时间的保留策略"}},[a._v("#")]),a._v(" 基于时间的保留策略")]),a._v(" "),s("p",[a._v("这是 Kafka 默认的数据删除策略，提供了配置项让我们可以按照日志被发布的时间来删除。它们分别是：")]),a._v(" "),s("ul",[s("li",[a._v("logs.retention.hours")]),a._v(" "),s("li",[a._v("logs.retention.minutes")]),a._v(" "),s("li",[a._v("logs.retention.ms")])]),a._v(" "),s("p",[a._v("log.retention.ms表示日志会被保留多少毫秒，如果为null，则Kafka会使用使用log.retention.minutes配置项。")]),a._v(" "),s("p",[a._v("log.retention.minutes表示日志会保留多少分钟，如果为null，则Kafka会使用log.retention.hours选项。")]),a._v(" "),s("p",[a._v("默认情况下，log.retention.ms和log.retention.minutes均为null，log.retention.hours为168，即Kafka的数据日志默认会被保留7天。如果想修改Kafka中数据日志被保留的时间长度，可以通过修改以上三个选项来实现。")]),a._v(" "),s("h3",{attrs:{id:"基于大小的保留策略"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#基于大小的保留策略"}},[a._v("#")]),a._v(" 基于大小的保留策略")]),a._v(" "),s("p",[a._v("Kafka除了提供了按时间删除的配置项外，也提供了按照日志文件的size来删除的配置项：")]),a._v(" "),s("ul",[s("li",[a._v("log.retention.bytes")])]),a._v(" "),s("p",[a._v("当 Kafka 某个 partition 的大小超过了"),s("code",[a._v("logs.retention.bytes")]),a._v("设置的值时，Kafka 就会删除旧的 segment。默认为-1，即无限制。")]),a._v(" "),s("blockquote",[s("p",[a._v("这个选项的值如果小于segment文件大小的话是不起作用的。segment文件的大小取决于log.segment.bytes配置项，默认为1G。 另外，Kafka的日志删除策略并不是非常严格的（比如如果log.retention.bytes设置了10G的话，并不是超过10G的部分就会立刻删除，只是被标记为待删除，Kafka会在恰当的时候再真正删除），所以请预留足够的磁盘空间。当磁盘空间剩余量为0时，Kafka服务会被kill掉")])]),a._v(" "),s("h2",{attrs:{id:"实际操作"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#实际操作"}},[a._v("#")]),a._v(" 实际操作")]),a._v(" "),s("h3",{attrs:{id:"查看某主题的数据保留时间"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看某主题的数据保留时间"}},[a._v("#")]),a._v(" "),s("strong",[a._v("查看某主题的数据保留时间")])]),a._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[a._v("./kafka-topics.sh "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--describe")]),a._v(" --bootstrap-server "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".1.174:9093 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--topic")]),a._v(" t2\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("输出")]),a._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[a._v("/opt/kafka_2.13-2.8.1/bin "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# ./kafka-topics.sh --describe --bootstrap-server 192.168.1.174:9093 --topic t2")]),a._v("\nTopic: t2       TopicId: BtPuVH1fT-Ckpyh4VXvKYQ PartitionCount: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3")]),a._v("       ReplicationFactor: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v("    Configs: "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("segment.bytes")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1073741824")]),a._v(",retention.ms"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("63072000")]),a._v("\n        Topic: t2       Partition: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("    Leader: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("       Replicas: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1,3")]),a._v("   Isr: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3,1")]),a._v("\n        Topic: t2       Partition: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("    Leader: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("       Replicas: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1,2")]),a._v("   Isr: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2,1")]),a._v("\n        Topic: t2       Partition: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v("    Leader: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3")]),a._v("       Replicas: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3,1")]),a._v("   Isr: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3,1")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br")])]),s("ul",[s("li",[s("code",[a._v("Topic: t2")]),a._v(": 主题名称。")]),a._v(" "),s("li",[s("code",[a._v("TopicId: BtPuVH1fT-Ckpyh4VXvKYQ")]),a._v(": 主题ID。")]),a._v(" "),s("li",[s("code",[a._v("PartitionCount: 3")]),a._v(": 主题的分区数量。")]),a._v(" "),s("li",[s("code",[a._v("ReplicationFactor: 2")]),a._v(": 主题的复制因子。")]),a._v(" "),s("li",[s("code",[a._v("segment.bytes")]),a._v("：此配置控制日志的段文件大小。一次保留和清理一个文件，因此较大的段大小意味着较少的文件，但对保留率的粒度控制较少。")]),a._v(" "),s("li",[s("code",[a._v("retention.m")]),a._v("s：如果我们使用“删除”保留策略，则此配置控制我们将保留日志的最长时间，然后我们将丢弃旧的日志段以释放空间。这代表SLA消费者必须读取数据的时间长度。")]),a._v(" "),s("li",[s("code",[a._v("Partition: 0")]),a._v("表示这是t2主题的第0个分区的信息")]),a._v(" "),s("li",[s("code",[a._v("Leader: 1")]),a._v("表示领导者副本在Broker 1上")]),a._v(" "),s("li",[s("code",[a._v("Replicas: 1,3")]),a._v("表示这个分区的副本位于Broker 1和Broker 3")]),a._v(" "),s("li",[s("code",[a._v("Isr: 3,1")]),a._v("表示In Sync副本有3号和1号，也就是哪些副本是和领导者副本保持同步的。")])]),a._v(" "),s("h3",{attrs:{id:"创建时指定主题的数据保留时间"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建时指定主题的数据保留时间"}},[a._v("#")]),a._v(" "),s("strong",[a._v("创建时指定主题的数据保留时间")])]),a._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建告警数据主题")]),a._v("\n./kafka-topics.sh "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--zookeeper")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".1.174:2182 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--create")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--topic")]),a._v(" oms_alert_data_topic "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--partitions")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v(" --replication-factor "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--config")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("retention.ms")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("63072000")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建实时数据主题")]),a._v("\n./kafka-topics.sh "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--zookeeper")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".1.174:2182 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--create")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--topic")]),a._v(" oms_state_data_topic "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--partitions")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v(" --replication-factor "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--config")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("retention.ms")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("63072000")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br")])]),s("h3",{attrs:{id:"修改指定主题的数据保留时间"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#修改指定主题的数据保留时间"}},[a._v("#")]),a._v(" "),s("strong",[a._v("修改指定主题的数据保留时间")])]),a._v(" "),s("p",[a._v("针对已经创建了的主题，设置主题"),s("code",[a._v("t2")]),a._v("的数据保留时间为72小时（63,072,000毫秒）")]),a._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[a._v("./kafka-configs.sh "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--zookeeper")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".1.174:2182 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--alter")]),a._v(" --entity-type topics --entity-name t2 --add-config "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("retention.ms")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("63072000")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])])])}),[],!1,null,null,null);s.default=r.exports}}]);