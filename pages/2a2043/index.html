<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>类加载子系统 | Gpingの知识库</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="记录学习路上的点点滴滴">
    <meta name="keywords" content="vuepress,theme,blog,vdoing">
    <meta name="theme-color" content="#11a8cd">
    <meta name="referrer" content="no-referrer">
    
    <link rel="preload" href="/assets/css/0.styles.18a91880.css" as="style"><link rel="preload" href="/assets/js/app.57e44612.js" as="script"><link rel="preload" href="/assets/js/2.ea24d1ee.js" as="script"><link rel="preload" href="/assets/js/18.3bb48241.js" as="script"><link rel="prefetch" href="/assets/js/10.87a7fc9a.js"><link rel="prefetch" href="/assets/js/100.1dde94ac.js"><link rel="prefetch" href="/assets/js/101.a9e60cd0.js"><link rel="prefetch" href="/assets/js/102.41fc30c1.js"><link rel="prefetch" href="/assets/js/103.d66d2d71.js"><link rel="prefetch" href="/assets/js/104.22cb586e.js"><link rel="prefetch" href="/assets/js/105.2e7087a4.js"><link rel="prefetch" href="/assets/js/106.f3ea04f4.js"><link rel="prefetch" href="/assets/js/107.1fe76475.js"><link rel="prefetch" href="/assets/js/108.5419a3bf.js"><link rel="prefetch" href="/assets/js/109.25f5a5d7.js"><link rel="prefetch" href="/assets/js/11.04f09971.js"><link rel="prefetch" href="/assets/js/110.859d6308.js"><link rel="prefetch" href="/assets/js/111.1007812c.js"><link rel="prefetch" href="/assets/js/112.1e3ac86b.js"><link rel="prefetch" href="/assets/js/113.39632362.js"><link rel="prefetch" href="/assets/js/114.cd109b57.js"><link rel="prefetch" href="/assets/js/115.738c1531.js"><link rel="prefetch" href="/assets/js/116.8afaf129.js"><link rel="prefetch" href="/assets/js/117.fc53579f.js"><link rel="prefetch" href="/assets/js/118.21a1f8c4.js"><link rel="prefetch" href="/assets/js/119.0a6295f3.js"><link rel="prefetch" href="/assets/js/12.39c155f1.js"><link rel="prefetch" href="/assets/js/120.b52ae2c0.js"><link rel="prefetch" href="/assets/js/121.a7d78631.js"><link rel="prefetch" href="/assets/js/122.a28e6a23.js"><link rel="prefetch" href="/assets/js/123.c426392a.js"><link rel="prefetch" href="/assets/js/124.c522482b.js"><link rel="prefetch" href="/assets/js/125.92a0ca2c.js"><link rel="prefetch" href="/assets/js/126.c7e332fc.js"><link rel="prefetch" href="/assets/js/127.09fed274.js"><link rel="prefetch" href="/assets/js/128.5b2b776f.js"><link rel="prefetch" href="/assets/js/129.78e15024.js"><link rel="prefetch" href="/assets/js/13.2b02d3de.js"><link rel="prefetch" href="/assets/js/130.97b2a44d.js"><link rel="prefetch" href="/assets/js/131.0453b852.js"><link rel="prefetch" href="/assets/js/132.1d3bd373.js"><link rel="prefetch" href="/assets/js/133.445fa178.js"><link rel="prefetch" href="/assets/js/134.10a04df0.js"><link rel="prefetch" href="/assets/js/135.7966ce33.js"><link rel="prefetch" href="/assets/js/136.03b5e675.js"><link rel="prefetch" href="/assets/js/137.5eed4831.js"><link rel="prefetch" href="/assets/js/138.ed4fba77.js"><link rel="prefetch" href="/assets/js/139.8eb46152.js"><link rel="prefetch" href="/assets/js/14.8881736c.js"><link rel="prefetch" href="/assets/js/140.08e196c0.js"><link rel="prefetch" href="/assets/js/141.b18b66b6.js"><link rel="prefetch" href="/assets/js/142.03a0879c.js"><link rel="prefetch" href="/assets/js/143.22fdbb7b.js"><link rel="prefetch" href="/assets/js/144.31189f97.js"><link rel="prefetch" href="/assets/js/145.75b2fd40.js"><link rel="prefetch" href="/assets/js/146.dbb475d1.js"><link rel="prefetch" href="/assets/js/147.cf107953.js"><link rel="prefetch" href="/assets/js/148.f9449ca9.js"><link rel="prefetch" href="/assets/js/149.6960a659.js"><link rel="prefetch" href="/assets/js/15.b4b6d9e8.js"><link rel="prefetch" href="/assets/js/150.f4a4a9e2.js"><link rel="prefetch" href="/assets/js/151.df5e1fda.js"><link rel="prefetch" href="/assets/js/152.b3ebe11a.js"><link rel="prefetch" href="/assets/js/153.fe7d6b3f.js"><link rel="prefetch" href="/assets/js/154.aeb16b2b.js"><link rel="prefetch" href="/assets/js/155.649eeac2.js"><link rel="prefetch" href="/assets/js/156.72888c77.js"><link rel="prefetch" href="/assets/js/157.dc67f246.js"><link rel="prefetch" href="/assets/js/158.467b9e3c.js"><link rel="prefetch" href="/assets/js/159.384e3132.js"><link rel="prefetch" href="/assets/js/16.e6a03cb0.js"><link rel="prefetch" href="/assets/js/160.75f72beb.js"><link rel="prefetch" href="/assets/js/161.c4bf3ed6.js"><link rel="prefetch" href="/assets/js/162.4e905989.js"><link rel="prefetch" href="/assets/js/163.e10e10ec.js"><link rel="prefetch" href="/assets/js/164.8c3e42dc.js"><link rel="prefetch" href="/assets/js/165.c9509c25.js"><link rel="prefetch" href="/assets/js/166.875c96b9.js"><link rel="prefetch" href="/assets/js/167.ac323741.js"><link rel="prefetch" href="/assets/js/168.6cff22a8.js"><link rel="prefetch" href="/assets/js/169.9a12d5c9.js"><link rel="prefetch" href="/assets/js/17.430c4645.js"><link rel="prefetch" href="/assets/js/170.bb307927.js"><link rel="prefetch" href="/assets/js/171.40dbf2b6.js"><link rel="prefetch" href="/assets/js/172.a11d0b5a.js"><link rel="prefetch" href="/assets/js/173.86064fd6.js"><link rel="prefetch" href="/assets/js/174.1cacb422.js"><link rel="prefetch" href="/assets/js/175.622de80a.js"><link rel="prefetch" href="/assets/js/176.de8449aa.js"><link rel="prefetch" href="/assets/js/177.cb9b484d.js"><link rel="prefetch" href="/assets/js/178.9f5c2068.js"><link rel="prefetch" href="/assets/js/179.ffff651e.js"><link rel="prefetch" href="/assets/js/180.09a9c21e.js"><link rel="prefetch" href="/assets/js/181.26ed76ed.js"><link rel="prefetch" href="/assets/js/182.17a77c05.js"><link rel="prefetch" href="/assets/js/183.53fafefd.js"><link rel="prefetch" href="/assets/js/184.a67c9279.js"><link rel="prefetch" href="/assets/js/185.5ef13915.js"><link rel="prefetch" href="/assets/js/186.80f2394f.js"><link rel="prefetch" href="/assets/js/187.9966ad44.js"><link rel="prefetch" href="/assets/js/188.03ff6401.js"><link rel="prefetch" href="/assets/js/189.0673741c.js"><link rel="prefetch" href="/assets/js/19.1a1d4b97.js"><link rel="prefetch" href="/assets/js/190.b00a4558.js"><link rel="prefetch" href="/assets/js/191.ffb3dc84.js"><link rel="prefetch" href="/assets/js/192.a1c08248.js"><link rel="prefetch" href="/assets/js/193.12c63e53.js"><link rel="prefetch" href="/assets/js/194.f33b52de.js"><link rel="prefetch" href="/assets/js/195.33c636d4.js"><link rel="prefetch" href="/assets/js/196.6c3d5dd1.js"><link rel="prefetch" href="/assets/js/197.30d1c025.js"><link rel="prefetch" href="/assets/js/198.452ad7b8.js"><link rel="prefetch" href="/assets/js/199.e5ef0a61.js"><link rel="prefetch" href="/assets/js/20.a60725d3.js"><link rel="prefetch" href="/assets/js/200.686c1f4c.js"><link rel="prefetch" href="/assets/js/201.bc89ccf8.js"><link rel="prefetch" href="/assets/js/202.59ba3183.js"><link rel="prefetch" href="/assets/js/203.bcd865f8.js"><link rel="prefetch" href="/assets/js/204.8d50c324.js"><link rel="prefetch" href="/assets/js/205.742dccae.js"><link rel="prefetch" href="/assets/js/206.88d6037a.js"><link rel="prefetch" href="/assets/js/207.190776c5.js"><link rel="prefetch" href="/assets/js/208.fa870ec7.js"><link rel="prefetch" href="/assets/js/209.0ead087a.js"><link rel="prefetch" href="/assets/js/21.6c56b6f5.js"><link rel="prefetch" href="/assets/js/210.4793eafd.js"><link rel="prefetch" href="/assets/js/211.d4701451.js"><link rel="prefetch" href="/assets/js/212.960f82e6.js"><link rel="prefetch" href="/assets/js/213.06afd767.js"><link rel="prefetch" href="/assets/js/214.7b98451d.js"><link rel="prefetch" href="/assets/js/215.78151312.js"><link rel="prefetch" href="/assets/js/216.d2f394e3.js"><link rel="prefetch" href="/assets/js/217.d6868358.js"><link rel="prefetch" href="/assets/js/218.74bb756c.js"><link rel="prefetch" href="/assets/js/219.6239b512.js"><link rel="prefetch" href="/assets/js/22.f0aec2af.js"><link rel="prefetch" href="/assets/js/220.18943948.js"><link rel="prefetch" href="/assets/js/221.952b0093.js"><link rel="prefetch" href="/assets/js/222.908dcde3.js"><link rel="prefetch" href="/assets/js/223.ccc9ca97.js"><link rel="prefetch" href="/assets/js/224.97bb1b38.js"><link rel="prefetch" href="/assets/js/225.f44d9991.js"><link rel="prefetch" href="/assets/js/226.0cbe1043.js"><link rel="prefetch" href="/assets/js/227.0ef2d9fa.js"><link rel="prefetch" href="/assets/js/228.08e2a12e.js"><link rel="prefetch" href="/assets/js/229.9d76c3da.js"><link rel="prefetch" href="/assets/js/23.b75f4ad8.js"><link rel="prefetch" href="/assets/js/230.0130ed60.js"><link rel="prefetch" href="/assets/js/231.cc7bfe6a.js"><link rel="prefetch" href="/assets/js/232.945b8961.js"><link rel="prefetch" href="/assets/js/233.b92a416e.js"><link rel="prefetch" href="/assets/js/234.1e603d6c.js"><link rel="prefetch" href="/assets/js/235.2cbbf26a.js"><link rel="prefetch" href="/assets/js/236.8c2d0914.js"><link rel="prefetch" href="/assets/js/237.6d37c843.js"><link rel="prefetch" href="/assets/js/238.328bfb17.js"><link rel="prefetch" href="/assets/js/239.3cfc2492.js"><link rel="prefetch" href="/assets/js/24.2f8e45fa.js"><link rel="prefetch" href="/assets/js/240.49c464d7.js"><link rel="prefetch" href="/assets/js/241.a117b6ed.js"><link rel="prefetch" href="/assets/js/242.f755edbf.js"><link rel="prefetch" href="/assets/js/243.d465b990.js"><link rel="prefetch" href="/assets/js/244.437ddc10.js"><link rel="prefetch" href="/assets/js/245.2e779b62.js"><link rel="prefetch" href="/assets/js/246.833a9e59.js"><link rel="prefetch" href="/assets/js/247.3642921c.js"><link rel="prefetch" href="/assets/js/248.6fe5d428.js"><link rel="prefetch" href="/assets/js/249.11831ea9.js"><link rel="prefetch" href="/assets/js/25.b05b892c.js"><link rel="prefetch" href="/assets/js/250.8c3ef99e.js"><link rel="prefetch" href="/assets/js/251.520e04bc.js"><link rel="prefetch" href="/assets/js/252.b091ccdc.js"><link rel="prefetch" href="/assets/js/253.b763e62c.js"><link rel="prefetch" href="/assets/js/254.4d336e26.js"><link rel="prefetch" href="/assets/js/255.5d47d641.js"><link rel="prefetch" href="/assets/js/256.baa3ebe3.js"><link rel="prefetch" href="/assets/js/257.2ffae9af.js"><link rel="prefetch" href="/assets/js/258.c604142e.js"><link rel="prefetch" href="/assets/js/259.e74e6cd6.js"><link rel="prefetch" href="/assets/js/26.8ba653c3.js"><link rel="prefetch" href="/assets/js/260.7b310562.js"><link rel="prefetch" href="/assets/js/261.e3b096df.js"><link rel="prefetch" href="/assets/js/262.808f799f.js"><link rel="prefetch" href="/assets/js/263.c560074f.js"><link rel="prefetch" href="/assets/js/264.a46a2877.js"><link rel="prefetch" href="/assets/js/265.d15875dc.js"><link rel="prefetch" href="/assets/js/266.44ad46e6.js"><link rel="prefetch" href="/assets/js/267.744591cc.js"><link rel="prefetch" href="/assets/js/268.b63a806f.js"><link rel="prefetch" href="/assets/js/269.2df63b7b.js"><link rel="prefetch" href="/assets/js/27.2649684b.js"><link rel="prefetch" href="/assets/js/270.96a1e8da.js"><link rel="prefetch" href="/assets/js/271.f7f48faf.js"><link rel="prefetch" href="/assets/js/272.89f1f9b3.js"><link rel="prefetch" href="/assets/js/273.9db895c8.js"><link rel="prefetch" href="/assets/js/28.04ba17fc.js"><link rel="prefetch" href="/assets/js/29.fc9bec6b.js"><link rel="prefetch" href="/assets/js/3.ebf0a2ca.js"><link rel="prefetch" href="/assets/js/30.8f6c8682.js"><link rel="prefetch" href="/assets/js/31.044a932c.js"><link rel="prefetch" href="/assets/js/32.f86a299c.js"><link rel="prefetch" href="/assets/js/33.69f05cd0.js"><link rel="prefetch" href="/assets/js/34.0fcfdfd2.js"><link rel="prefetch" href="/assets/js/35.fbba2378.js"><link rel="prefetch" href="/assets/js/36.b8c83634.js"><link rel="prefetch" href="/assets/js/37.af10d35c.js"><link rel="prefetch" href="/assets/js/38.40c50958.js"><link rel="prefetch" href="/assets/js/39.048effca.js"><link rel="prefetch" href="/assets/js/4.910990f1.js"><link rel="prefetch" href="/assets/js/40.34df2e9c.js"><link rel="prefetch" href="/assets/js/41.0d92c05d.js"><link rel="prefetch" href="/assets/js/42.7d55e3eb.js"><link rel="prefetch" href="/assets/js/43.784d6526.js"><link rel="prefetch" href="/assets/js/44.ab75d220.js"><link rel="prefetch" href="/assets/js/45.1da53631.js"><link rel="prefetch" href="/assets/js/46.2bc19c98.js"><link rel="prefetch" href="/assets/js/47.ebb349e1.js"><link rel="prefetch" href="/assets/js/48.4c790e5f.js"><link rel="prefetch" href="/assets/js/49.a08ffcbf.js"><link rel="prefetch" href="/assets/js/5.1a4306f1.js"><link rel="prefetch" href="/assets/js/50.2a986267.js"><link rel="prefetch" href="/assets/js/51.b6e6ae81.js"><link rel="prefetch" href="/assets/js/52.884f6499.js"><link rel="prefetch" href="/assets/js/53.21026904.js"><link rel="prefetch" href="/assets/js/54.da32fcd7.js"><link rel="prefetch" href="/assets/js/55.8b53dfa1.js"><link rel="prefetch" href="/assets/js/56.f61d102d.js"><link rel="prefetch" href="/assets/js/57.f4da3322.js"><link rel="prefetch" href="/assets/js/58.5e3282e7.js"><link rel="prefetch" href="/assets/js/59.a84fd4f0.js"><link rel="prefetch" href="/assets/js/6.051801a8.js"><link rel="prefetch" href="/assets/js/60.5946ddf4.js"><link rel="prefetch" href="/assets/js/61.18c749ab.js"><link rel="prefetch" href="/assets/js/62.da684abf.js"><link rel="prefetch" href="/assets/js/63.2b0fa974.js"><link rel="prefetch" href="/assets/js/64.2f400a86.js"><link rel="prefetch" href="/assets/js/65.4cf2386f.js"><link rel="prefetch" href="/assets/js/66.188c4b33.js"><link rel="prefetch" href="/assets/js/67.b4f824ac.js"><link rel="prefetch" href="/assets/js/68.d77410fc.js"><link rel="prefetch" href="/assets/js/69.6e24eb76.js"><link rel="prefetch" href="/assets/js/7.8cdfab2f.js"><link rel="prefetch" href="/assets/js/70.5ca51a92.js"><link rel="prefetch" href="/assets/js/71.35d7ed60.js"><link rel="prefetch" href="/assets/js/72.a7853bf5.js"><link rel="prefetch" href="/assets/js/73.a891df77.js"><link rel="prefetch" href="/assets/js/74.e978df7f.js"><link rel="prefetch" href="/assets/js/75.ab5a4524.js"><link rel="prefetch" href="/assets/js/76.ea1c6d79.js"><link rel="prefetch" href="/assets/js/77.711c0174.js"><link rel="prefetch" href="/assets/js/78.35dd5c6c.js"><link rel="prefetch" href="/assets/js/79.d7524830.js"><link rel="prefetch" href="/assets/js/8.badb7759.js"><link rel="prefetch" href="/assets/js/80.7e16490b.js"><link rel="prefetch" href="/assets/js/81.15f00868.js"><link rel="prefetch" href="/assets/js/82.0fe7b576.js"><link rel="prefetch" href="/assets/js/83.fc62b16f.js"><link rel="prefetch" href="/assets/js/84.2a4f555c.js"><link rel="prefetch" href="/assets/js/85.edffb2ef.js"><link rel="prefetch" href="/assets/js/86.69991118.js"><link rel="prefetch" href="/assets/js/87.621cee7a.js"><link rel="prefetch" href="/assets/js/88.5507cc10.js"><link rel="prefetch" href="/assets/js/89.5d34d988.js"><link rel="prefetch" href="/assets/js/9.d4fc76e7.js"><link rel="prefetch" href="/assets/js/90.cc841762.js"><link rel="prefetch" href="/assets/js/91.a24381d0.js"><link rel="prefetch" href="/assets/js/92.cbd5d458.js"><link rel="prefetch" href="/assets/js/93.530432c0.js"><link rel="prefetch" href="/assets/js/94.0524cfdd.js"><link rel="prefetch" href="/assets/js/95.0214ae22.js"><link rel="prefetch" href="/assets/js/96.7942792a.js"><link rel="prefetch" href="/assets/js/97.35d91de8.js"><link rel="prefetch" href="/assets/js/98.eafbdc44.js"><link rel="prefetch" href="/assets/js/99.db414aab.js">
    <link rel="stylesheet" href="/assets/css/0.styles.18a91880.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="Gpingの知识库" class="logo"> <span class="site-name can-hide">Gpingの知识库</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">🏠首页</a></div><div class="nav-item"><a href="/pages/2dbd58/" class="nav-link">📚小手册</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="📖基础" class="dropdown-title"><!----> <span class="title" style="display:;">📖基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/27f9fa/" class="nav-link">Java8新特性</a></li><li class="dropdown-item"><!----> <a href="/pages/96d5aa/" class="nav-link">Java并发编程</a></li><li class="dropdown-item"><!----> <a href="/pages/00e30d/" class="nav-link">Java虚拟机</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🏷️框架" class="dropdown-title"><!----> <span class="title" style="display:;">🏷️框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/bb39d9/" class="nav-link">Spring</a></li><li class="dropdown-item"><!----> <a href="/pages/24c3ee/" class="nav-link">SpringSecurity</a></li><li class="dropdown-item"><!----> <a href="/pages/1ab42b/" class="nav-link">ThingsBoard</a></li><li class="dropdown-item"><!----> <a href="/pages/fb96c3/" class="nav-link">Jpa</a></li><li class="dropdown-item"><!----> <a href="/pages/34b19f/" class="nav-link">Activiti7</a></li><li class="dropdown-item"><!----> <a href="/pages/d33c62/" class="nav-link">Quartz</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="⚔️中间件" class="dropdown-title"><!----> <span class="title" style="display:;">⚔️中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/c4d661/" class="nav-link">Rabbitmq</a></li><li class="dropdown-item"><!----> <a href="/pages/fe0a41/" class="nav-link">Kafka</a></li><li class="dropdown-item"><!----> <a href="/pages/eeddc3/" class="nav-link">Canal</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="📁数据库" class="dropdown-title"><!----> <span class="title" style="display:;">📁数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/0ef684/" class="nav-link">Mysql</a></li><li class="dropdown-item"><!----> <a href="/pages/a174cd/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/pages/4cfb74/" class="nav-link">InfluxDB</a></li><li class="dropdown-item"><!----> <a href="/pages/9c8057/" class="nav-link">ClickHouse</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🧰实用工具" class="dropdown-title"><!----> <span class="title" style="display:;">🧰实用工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/32a577/" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/pages/9864be/" class="nav-link">Maven</a></li><li class="dropdown-item"><!----> <a href="/pages/f5b30e/" class="nav-link">Nginx</a></li><li class="dropdown-item"><!----> <a href="/pages/290042/" class="nav-link">Arthas</a></li><li class="dropdown-item"><!----> <a href="/pages/9eb455/" class="nav-link">Idea</a></li><li class="dropdown-item"><!----> <a href="/pages/151c97/" class="nav-link">开发工具</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🐞运维" class="dropdown-title"><!----> <span class="title" style="display:;">🐞运维</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/748b9f/" class="nav-link">Docker</a></li><li class="dropdown-item"><!----> <a href="/pages/4b6fee/" class="nav-link">Linux</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="💡其他" class="dropdown-title"><!----> <span class="title" style="display:;">💡其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/9cc0e1/" class="nav-link">高项</a></li><li class="dropdown-item"><!----> <a href="/pages/10e161/" class="nav-link">不一样的树形构建方式</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">🏠首页</a></div><div class="nav-item"><a href="/pages/2dbd58/" class="nav-link">📚小手册</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="📖基础" class="dropdown-title"><!----> <span class="title" style="display:;">📖基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/27f9fa/" class="nav-link">Java8新特性</a></li><li class="dropdown-item"><!----> <a href="/pages/96d5aa/" class="nav-link">Java并发编程</a></li><li class="dropdown-item"><!----> <a href="/pages/00e30d/" class="nav-link">Java虚拟机</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🏷️框架" class="dropdown-title"><!----> <span class="title" style="display:;">🏷️框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/bb39d9/" class="nav-link">Spring</a></li><li class="dropdown-item"><!----> <a href="/pages/24c3ee/" class="nav-link">SpringSecurity</a></li><li class="dropdown-item"><!----> <a href="/pages/1ab42b/" class="nav-link">ThingsBoard</a></li><li class="dropdown-item"><!----> <a href="/pages/fb96c3/" class="nav-link">Jpa</a></li><li class="dropdown-item"><!----> <a href="/pages/34b19f/" class="nav-link">Activiti7</a></li><li class="dropdown-item"><!----> <a href="/pages/d33c62/" class="nav-link">Quartz</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="⚔️中间件" class="dropdown-title"><!----> <span class="title" style="display:;">⚔️中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/c4d661/" class="nav-link">Rabbitmq</a></li><li class="dropdown-item"><!----> <a href="/pages/fe0a41/" class="nav-link">Kafka</a></li><li class="dropdown-item"><!----> <a href="/pages/eeddc3/" class="nav-link">Canal</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="📁数据库" class="dropdown-title"><!----> <span class="title" style="display:;">📁数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/0ef684/" class="nav-link">Mysql</a></li><li class="dropdown-item"><!----> <a href="/pages/a174cd/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/pages/4cfb74/" class="nav-link">InfluxDB</a></li><li class="dropdown-item"><!----> <a href="/pages/9c8057/" class="nav-link">ClickHouse</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🧰实用工具" class="dropdown-title"><!----> <span class="title" style="display:;">🧰实用工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/32a577/" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/pages/9864be/" class="nav-link">Maven</a></li><li class="dropdown-item"><!----> <a href="/pages/f5b30e/" class="nav-link">Nginx</a></li><li class="dropdown-item"><!----> <a href="/pages/290042/" class="nav-link">Arthas</a></li><li class="dropdown-item"><!----> <a href="/pages/9eb455/" class="nav-link">Idea</a></li><li class="dropdown-item"><!----> <a href="/pages/151c97/" class="nav-link">开发工具</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🐞运维" class="dropdown-title"><!----> <span class="title" style="display:;">🐞运维</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/748b9f/" class="nav-link">Docker</a></li><li class="dropdown-item"><!----> <a href="/pages/4b6fee/" class="nav-link">Linux</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="💡其他" class="dropdown-title"><!----> <span class="title" style="display:;">💡其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/9cc0e1/" class="nav-link">高项</a></li><li class="dropdown-item"><!----> <a href="/pages/10e161/" class="nav-link">不一样的树形构建方式</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>JVM</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>内存与垃圾回收篇</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/00e30d/" class="sidebar-link">JVM与Java体系结构</a></li><li><a href="/pages/2a2043/" aria-current="page" class="active sidebar-link">类加载子系统</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/2a2043/#类加载子系统" class="sidebar-link">类加载子系统</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/2a2043/#类加载器与类的加载过程" class="sidebar-link">类加载器与类的加载过程</a></li><li class="sidebar-sub-header level4"><a href="/pages/2a2043/#加载阶段" class="sidebar-link">加载阶段</a></li><li class="sidebar-sub-header level4"><a href="/pages/2a2043/#链接阶段" class="sidebar-link">链接阶段</a></li><li class="sidebar-sub-header level5"><a href="/pages/2a2043/#验证" class="sidebar-link">验证</a></li><li class="sidebar-sub-header level5"><a href="/pages/2a2043/#准备" class="sidebar-link">准备</a></li><li class="sidebar-sub-header level5"><a href="/pages/2a2043/#解析" class="sidebar-link">解析</a></li><li class="sidebar-sub-header level4"><a href="/pages/2a2043/#初始化" class="sidebar-link">初始化</a></li><li class="sidebar-sub-header level3"><a href="/pages/2a2043/#类加载器的分类" class="sidebar-link">类加载器的分类</a></li><li class="sidebar-sub-header level4"><a href="/pages/2a2043/#虚拟机自带的加载器" class="sidebar-link">虚拟机自带的加载器</a></li><li class="sidebar-sub-header level4"><a href="/pages/2a2043/#用户自定义类加载器" class="sidebar-link">用户自定义类加载器</a></li><li class="sidebar-sub-header level3"><a href="/pages/2a2043/#classloader的api" class="sidebar-link">ClassLoader的API</a></li><li class="sidebar-sub-header level3"><a href="/pages/2a2043/#双亲委派机制" class="sidebar-link">双亲委派机制</a></li><li class="sidebar-sub-header level4"><a href="/pages/2a2043/#工作原理" class="sidebar-link">工作原理</a></li><li class="sidebar-sub-header level4"><a href="/pages/2a2043/#好处" class="sidebar-link">好处</a></li><li class="sidebar-sub-header level4"><a href="/pages/2a2043/#jndi" class="sidebar-link">JNDI</a></li><li class="sidebar-sub-header level4"><a href="/pages/2a2043/#spi" class="sidebar-link">SPI</a></li><li class="sidebar-sub-header level4"><a href="/pages/2a2043/#自定义spi接口" class="sidebar-link">自定义SPI接口</a></li><li class="sidebar-sub-header level4"><a href="/pages/2a2043/#spi源码解析" class="sidebar-link">SPI源码解析</a></li><li class="sidebar-sub-header level4"><a href="/pages/2a2043/#spi打破双亲委派机制" class="sidebar-link">SPI打破双亲委派机制</a></li><li class="sidebar-sub-header level4"><a href="/pages/2a2043/#jdbc举例" class="sidebar-link">JDBC举例</a></li><li class="sidebar-sub-header level3"><a href="/pages/2a2043/#其他" class="sidebar-link">其他</a></li><li class="sidebar-sub-header level4"><a href="/pages/2a2043/#如何判断两个class对象是否相同" class="sidebar-link">如何判断两个class对象是否相同</a></li><li class="sidebar-sub-header level4"><a href="/pages/2a2043/#对类加载器的引用" class="sidebar-link">对类加载器的引用</a></li><li class="sidebar-sub-header level4"><a href="/pages/2a2043/#类的主动使用和被动使用" class="sidebar-link">类的主动使用和被动使用</a></li></ul></li></ul></li><li><a href="/pages/2898db/" class="sidebar-link">运行时数据区</a></li><li><a href="/pages/24f838/" class="sidebar-link">程序计数器（PC寄存器）</a></li><li><a href="/pages/27bd58/" class="sidebar-link">虚拟机栈</a></li><li><a href="/pages/59ab02/" class="sidebar-link">本地方法栈和本地方法接口</a></li><li><a href="/pages/1553ef/" class="sidebar-link">Java堆</a></li><li><a href="/pages/5703a7/" class="sidebar-link">方法区</a></li><li><a href="/pages/ac9d50/" class="sidebar-link">对象实例化及直接内存</a></li><li><a href="/pages/4f7794/" class="sidebar-link">执行引擎</a></li><li><a href="/pages/af351d/" class="sidebar-link">String Table</a></li><li><a href="/pages/7fecdf/" class="sidebar-link">垃圾收集概述</a></li><li><a href="/pages/64d576/" class="sidebar-link">垃圾收集算法</a></li><li><a href="/pages/9777ac/" class="sidebar-link">垃圾收集相关概念</a></li><li><a href="/pages/f50a3c/" class="sidebar-link">垃圾收集器</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>字节码与类的加载篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>性能监控与调优篇</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>JVM</span></li><li data-v-06225672><span data-v-06225672>JVM</span></li><li data-v-06225672><span data-v-06225672>内存与垃圾回收篇</span></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="javascript:;" data-v-06225672>gping</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-10-22</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">类加载子系统<!----></h1>  <div class="theme-vdoing-content content__default"><h2 id="类加载子系统"><a href="#类加载子系统" class="header-anchor">#</a> 类加载子系统</h2> <h3 id="类加载器与类的加载过程"><a href="#类加载器与类的加载过程" class="header-anchor">#</a> 类加载器与类的加载过程</h3> <p><strong>类的加载过程</strong></p> <p><img src="https://gitee.com/studentgitee/note-picture/raw/master/%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B2.drawio.png" alt="对象的创建过程2.drawio"></p> <h4 id="加载阶段"><a href="#加载阶段" class="header-anchor">#</a> 加载阶段</h4> <p><img src="https://gitee.com/studentgitee/note-picture/raw/master/image-20230729102940324.png" alt="image-20230729102940324"></p> <ul><li>通过一个类的全限定名获取定义此类的二进制字节流</li> <li>将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构</li> <li>在内存中生成一个代表这个类的java.lang.Class对象，作为方法区这个类的各种数据的访问入口</li></ul> <p><strong>加载class文件的方式</strong></p> <ul><li>从本地系统中直接加载</li> <li>通过网络获取，典型场景：Web Applet</li> <li>从zip压缩包中读取，成为日后jar、war格式的基础</li> <li>运行时计算生成，使用最多的是：动态代理技术</li> <li>由其他文件生成，典型场景：JSP应用从专有数据库中提取.class文件，比较少见</li> <li>从加密文件中获取，典型的防Class文件被反编译的保护措施</li></ul> <h4 id="链接阶段"><a href="#链接阶段" class="header-anchor">#</a> 链接阶段</h4> <h5 id="验证"><a href="#验证" class="header-anchor">#</a> 验证</h5> <blockquote><p>验证字节码是否符合JVM规范和安全要求，包括文件格式验证、元数据验证、字节码验证和符号引用验证。</p></blockquote> <p><strong>文件格式验证</strong></p> <ul><li>是否以魔数0xCAFEBABE开头</li></ul> <p><img src="https://gitee.com/studentgitee/note-picture/raw/master/image-20200705084038680.png" alt="image-20200705084038680"></p> <ul><li>主、次版本号是否在当前Java虚拟机接受范围之内</li> <li>常量池的常量中是否有不被支持的常量类型（检查常量tag标志）</li> <li>指向常量的各种索引值中是否有指向不存在的常量或不符合类型的常量</li> <li>CONSTANT_Utf8_info型的常量中是否有不符合UTF-8编码的数据</li> <li>............</li></ul> <p><strong>元数据验证</strong></p> <ul><li>这个类是否有父类（除了java.lang.Object之外，所有的类都应当有父类）</li> <li>这个类的父类是否继承了不允许被继承的类（被final修饰的类）</li> <li>如果这个类不是抽象类，是否实现了其父类或接口之中要求实现的所有方法</li> <li>............</li></ul> <p><strong>字节码验证</strong></p> <ul><li>保证任意时刻操作数栈的数据类型与指令代码序列都能配合工作，例如不会出现类似于“在操作栈放置了一个int类型的数据，使用时却按long类型来加载入本地变量表中”这样的情况</li> <li>保证任何跳转指令都不会跳转到方法体以外的字节码指令上</li> <li>保证方法体中的类型转换总是有效的，例如可以把一个子类对象赋值给父类数据类型，这是安全的，但是把父类对象赋值给子类数据类型，甚至把对象赋值给与它毫无继承关系、完全不相干的一个数据类型，则是危险和不合法的</li> <li>............</li></ul> <p><strong>符号引用验证</strong></p> <p>最后一个阶段的校验行为发生在虚拟机将符号引用转化为直接引用 的时候，这个转化动作将在连接的第三阶段——解析阶段中发生。符号引用验证可以看作是对类自身以外（常量池中的各种符号引用）的各类信息进行匹配性校验，通俗来说就是，该类是否缺少或者被禁止访问它依赖的某些外部类、方法、字段等资源。本阶段通常需要校验下列内容</p> <ul><li>符号引用中通过字符串描述的全限定名是否能找到对应的类</li> <li>在指定类中是否存在符合方法的字段描述符及简单名称所描述的方法和字段</li> <li>符号引用中的类、字段、方法的可访问性（private、protected、public、<code>&lt;package&gt;</code>）是否可被当前类访问</li> <li>............</li></ul> <h5 id="准备"><a href="#准备" class="header-anchor">#</a> 准备</h5> <p>当类加载器加载类时，在准备阶段会为类变量（静态变量）进行初始化：</p> <ol><li>对于<code>final static</code>变量，会在准备阶段被赋予指定的初始值，而不是默认值。</li> <li>对于非<code>final static</code>变量，会在准备阶段被赋予默认值（0、false、null等）。</li> <li>实例变量（非静态变量）不在准备阶段进行初始化，而是在对象创建时自动被赋予默认值。</li></ol> <p>下面是对每个情况的具体说明和示例：</p> <p>对于<code>final static</code>变量，会在准备阶段被赋予指定的初始值，而不是默认值。这是因为<code>final static</code>变量在类加载过程中会被视为常量，所以需要在准备阶段就进行初始化。例如：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyClass</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MY_CONSTANT</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在准备阶段，<code>MY_CONSTANT</code>会被赋予初始值10。</p> <p>对于非<code>final static</code>变量，会在准备阶段被赋予默认值（0、false、null等）。这是因为非<code>final static</code>变量可以在后续的初始化阶段再进行赋值。例如：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyClass</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> myVariable<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在准备阶段，<code>myVariable</code>会被赋予默认值0。</p> <ol><li>实例变量（非静态变量）不在准备阶段进行初始化，而是在对象创建时自动被赋予默认值。例如：</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyClass</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> myVariable<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在对象创建时，<code>myVariable</code>会被赋予默认值0。</p> <p><strong>基本数据类型的零值如下表所示</strong></p> <p><img src="https://gitee.com/studentgitee/note-picture/raw/master/image-20230729111059600.png" alt="image-20230729111059600"></p> <h5 id="解析"><a href="#解析" class="header-anchor">#</a> 解析</h5> <blockquote><p>解析阶段是Java虚拟机将常量池内的符号引用替换为直接引用的过程</p></blockquote> <blockquote><p>解析动作主要针对类或接口、字段、类方法、接口方法、方法类型、方法句柄和调用点限定符这7类符号引用进行，分别对应于常量池的CONSTANT_Class_info、CON-STANT_Fieldref_info、CONSTANT_Methodref_info、CONSTANT_InterfaceMethodref_info、CONSTANT_MethodType_info、CONSTANT_MethodHandle_info、CONSTANT_Dyna-mic_info和CONSTANT_InvokeDynamic_info 8种常量类型</p></blockquote> <p><strong>符号引用（Symbolic References）</strong></p> <p>符号引用以一组符号来描述所引用的目标，符号可以是任何形式的字面量，只要使用时能无歧义地定位到目标即可。符号引用与虚拟机实现的内存布局无关，引用的目标并不一定是已经加载到虚拟机内存当中的内容。各种虚拟机实现的内存布局可以各不相同，但是它们能接受的符号引用必须都是一致的，因为符号引用的字面量形式明确定义在《Java虚拟机规范》的Class文件格式中。</p> <p>举例来说明：</p> <ol><li>类的符号引用：在Java中，可以使用类的全限定名来引用一个类。例如，String.class就是一个类的符号引用，它表示对String类的引用。</li> <li>字段的符号引用：在Java中，可以使用类的全限定名和字段名来引用一个字段。例如，String.length就是一个字段的符号引用，它表示对String类的length字段的引用。</li> <li>方法的符号引用：在Java中，可以使用类的全限定名、方法名和方法参数类型来引用一个方法。例如，System.out.println(String)就是一个方法的符号引用，它表示对System.out类的println方法的引用。</li></ol> <p>总结起来，符号引用是一组符号来描述所引用的目标，可以是类、字段、方法等。它与虚拟机实现的内存布局无关，引用的目标不一定是已经加载到虚拟机内存中的内容。不同虚拟机实现的内存布局可以不同，但是它们接受的符号引用必须是一致的，因为符号引用的字面量形式在《Java虚拟机规范》的Class文件格式中明确定义。</p> <p><strong>直接引用（Direct References）</strong></p> <p>直接引用是可以直接指向目标的指针、相对偏移量或者是一个能间接定位到目标的句柄。直接引用是和虚拟机实现的内存布局直接相关的，同一个符号引用在不同虚拟机实例上翻译出来的直接引用一般不会相同。如果有了直接引用，那引用的目标必定已经在虚拟机的内存中存在。</p> <p>对于Java的JVM，直接引用是指在字节码中使用的符号引用在类加载过程中解析后得到的直接指向目标的指针。在JVM中，直接引用可以是指向对象实例的指针、指向类的指针、指向方法的指针等。</p> <p>举例来说明：</p> <ol><li>对象实例的直接引用：在Java中，可以使用对象的引用来直接引用一个对象实例。例如，Person p = new Person(); 这里的p就是一个直接引用，指向一个Person对象的实例。</li> <li>类的直接引用：在Java中，可以使用类的引用来直接引用一个类。例如，Class clazz = Person.class; 这里的clazz就是一个直接引用，指向Person类。</li> <li>方法的直接引用：在Java中，可以使用方法的引用来直接引用一个方法。例如，Runnable r = this::run; 这里的r就是一个直接引用，指向当前对象的run方法。</li></ol> <p>总结起来，对于Java的JVM，直接引用是指在类加载过程中解析后得到的直接指向目标的指针。它可以是指向对象实例、类、方法等的指针。通过直接引用，可以直接访问引用的目标。</p> <h4 id="初始化"><a href="#初始化" class="header-anchor">#</a> 初始化</h4> <blockquote><p>初始化阶段就是执行类构造器法<code>&lt;clinit&gt;（）</code>的过程。</p></blockquote> <p>此方法不需定义，是javac编译器自动收集类中的<code>所有类变量的赋值动作</code>和<code>静态代码块中的语句</code>合并而来。</p> <ul><li>也就是说，当我们代码中包含static变量的时候，就会有clinit方法.</li> <li>构造器方法中指令按语句在源文件中出现的顺序执行。</li> <li><code>&lt;clinit&gt;（）</code>不同于类的构造器（即在虚拟机视角中的实例构造器<code>&lt;init&gt;()</code>方法），若该类具有父类，JVM会保证子类的<code>&lt;clinit&gt;（）</code>执行前，父类的<code>&lt;clinit&gt;（）</code>已经执行完毕。</li> <li>任何一个类在声明后，都有生成一个构造器，默认是空参构造器.</li> <li>Java虚拟机确保在多线程环境中正确地加锁同步一个类的<code>&lt;clinit&gt;()</code>方法。如果多个线程同时初始化一个类，只有一个线程会执行该类的<code>&lt;clinit&gt;()</code>方法，其他线程会被阻塞等待，直到活动线程执行完<code>&lt;clinit&gt;()</code>方法。这样可以保证类的初始化只会执行一次，并且在多线程环境下不会出现竞争条件或不一致的情况。</li></ul> <p>在<code>&lt;clinit&gt;()</code>方法中，可以进行一些其他的初始化操作，如为静态变量赋予程序员指定的初始值，执行静态代码块中的代码等。这些操作会在初始化阶段执行，并且只会执行一次。</p> <p>以下是一个示例：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyClass</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> myStaticVariable<span class="token punctuation">;</span>
    
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;执行静态代码块&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        myStaticVariable <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;静态变量的值为：&quot;</span> <span class="token operator">+</span> myStaticVariable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>在上面的示例中，<code>MyClass</code>类包含一个静态变量<code>myStaticVariable</code>和一个静态代码块。在<code>&lt;clinit&gt;()</code>方法中，会执行静态代码块中的代码，即输出&quot;执行静态代码块&quot;并将<code>myStaticVariable</code>赋值为10。</p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>初始化阶段是为<code>静态变量赋予程序员指定的初始值</code>，而在准备阶段是<code>默认值</code>;</p></div> <p>考虑以下示例代码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Parent</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Parent class initialized&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Child</span> <span class="token keyword">extends</span> <span class="token class-name">Parent</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Child class initialized&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Parent class initialized</span>
        <span class="token comment">// Child class initialized</span>
        <span class="token comment">// Main method</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Main method&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>在上述代码中，<code>Child</code> 类继承自 <code>Parent</code> 类。当执行 <code>Child</code> 类的 <code>main</code> 方法时，会触发 <code>Child</code> 类的初始化过程。</p> <p>可以看到，<code>Parent</code> 类的 <code>&lt;clinit&gt;()</code> 方法被先执行，符合 Java 虚拟机保证在子类的 <code>&lt;clinit&gt;()</code> 方法执行前，父类的 <code>&lt;clinit&gt;()</code> 方法已经执行完毕的规定。因此，在 Java 虚拟机中，第一个被执行的 <code>&lt;clinit&gt;()</code> 方法的类型确实是 <code>java.lang.Object</code>，因为所有的类都间接或直接继承自 <code>Object</code> 类。</p> <h3 id="类加载器的分类"><a href="#类加载器的分类" class="header-anchor">#</a> 类加载器的分类</h3> <p><img src="https://gitee.com/studentgitee/note-picture/raw/master/v2-e2afb5f083b2135343851370890f4a66_r.jpg" alt="v2-e2afb5f083b2135343851370890f4a66_r"></p> <p>这里类加载器之间的父子关系一般不是以继承（Inheritance）的关系来实现的，<code>而是通常使用组合（Composition）关系来复用父加载器的代码。</code></p> <p><strong>类加载器具体是怎么样组合的？</strong></p> <p>在 Java 中，类加载器之间的组合关系是通过构造函数来实现的。每个类加载器都可以指定一个父加载器，当它需要加载类或资源时，会首先委托给父加载器进行尝试。如果父加载器无法加载，子加载器才会尝试加载。这样就形成了一种类加载器的层次结构，实现了代码复用和资源共享。</p> <p>我们来看一下源码解析，以 <code>ClassLoader</code> 类的源码为例，简化的示例如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>public class CustomClassLoader extends ClassLoader {
    public CustomClassLoader(ClassLoader parent) {
        super(parent);
    }

    @Override
    protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException {
        // 自定义类加载逻辑，查找并加载指定名称的类
        // 如果找不到，委托给父加载器进行尝试
        // 如果所有父加载器都无法加载，则调用本类的defineClass方法加载类
        // ...

        return defineClass(name, classBytes, 0, classBytes.length);
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>在上面的示例中，我们创建了一个名为 <code>CustomClassLoader</code> 的自定义类加载器，它继承自 <code>ClassLoader</code> 类。在自定义类加载器的构造函数中，通过 <code>super(parent)</code> 来显式指定了父加载器。这就是通过构造函数来实现类加载器之间的组合关系。</p> <p>当 <code>CustomClassLoader</code> 需要加载类时，首先会尝试委托给父加载器加载。如果父加载器无法加载，它会尝试使用自定义的类加载逻辑（<code>findClass</code> 方法）进行加载。在加载过程中，如果所有的父加载器都无法加载指定的类，最终会调用 <code>defineClass</code> 方法来加载类字节码，从而完成类的加载过程。</p> <p>这种方式实现了类加载器之间的组合关系，父加载器负责尝试加载类，子加载器负责具体的加载逻辑。这样可以实现代码复用和资源共享，同时保持了类加载器的隔离性和灵活性。</p> <h4 id="虚拟机自带的加载器"><a href="#虚拟机自带的加载器" class="header-anchor">#</a> 虚拟机自带的加载器</h4> <p><strong>启动类加载器（引导类加载器，Bootstrap ClassLoader）</strong></p> <ul><li><p>这个类加载<code>使用C/C++语言</code>实现的，嵌套在JVM内部。</p></li> <li><p>它用来加载Java的核心库（<code>JAVA_HOME/jre/lib/rt.jar</code>、<code>resources.jar</code>或<code>sun.boot.class.path</code>路径下的内容），用于提供JVM自身需要的类</p></li> <li><p><code>并不继承自java.lang.ClassLoader，没有父加载器</code>。</p></li> <li><p>加载扩展类和应用程序类加载器，并指定为他们的父类加载器。</p></li> <li><p>出于安全考虑，Bootstrap启动类加载器只加载包名为<code>java</code>、<code>javax</code>、<code>sun</code>等开头的类</p></li></ul> <p><strong>扩展类加载器（Extension ClassLoader）</strong></p> <ul><li>Java语言编写，由sun.misc.Launcher$ExtClassLoader实现。</li> <li>派生于ClassLoader类</li> <li>父类加载器为启动类加载器</li> <li>从<code>java.ext.dirs</code>系统属性所指定的目录中加载类库，或从JDK的安装目录的<code>jre/lib/ext</code>子目录（扩展目录）下加载类库。如果用户创建的JAR放在此目录下，也会自动由扩展类加载器加载。</li> <li>通过ClassLoader#getSystemClassLoader()#getParent() 方法可以获取到该类加载器</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExtClassLoaderExample</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ClassLoader</span> extClassLoader <span class="token operator">=</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 输出扩展类加载器的名称</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Extension Class Loader: &quot;</span> <span class="token operator">+</span> extClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 尝试加载一个类，查看其类加载器</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> exampleClass <span class="token operator">=</span> extClassLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">&quot;com.example.ExampleClass&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ClassLoader</span> classLoader <span class="token operator">=</span> exampleClass<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Class Loaded by: &quot;</span> <span class="token operator">+</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Class not found.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><img src="https://gitee.com/studentgitee/note-picture/raw/master/image-20230812113005278.png" alt="image-20230812113005278"></p> <p><strong>应用程序类加载器（系统类加载器，AppClassLoader）</strong></p> <ul><li>java语言编写，由<code>sun.misc.LaunchersAppClassLoader实现</code></li> <li>派生于ClassLoader类</li> <li>父类加载器为扩展类加载器</li> <li>它负责加载<code>环境变量classpath</code>或<code>系统属性java.class.path</code>指定路径下的类库</li></ul> <p>举个例子，假设你有一个名为 <code>MyApp</code> 的 Java 应用程序，其项目结构如下：</p> <div class="language-jav line-numbers-mode"><pre class="language-text"><code>MyApp/
├── lib/
│   ├── common-utils.jar
│   └── third-party-library.jar
├── src/
│   └── com/
│       └── myapp/
│           └── Main.java
└── target/

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>在这个示例中，<code>lib/</code> 目录下存放了两个库文件 <code>common-utils.jar</code> 和 <code>third-party-library.jar</code>。<code>src/</code> 目录下是应用程序的源代码，<code>target/</code> 目录是编译后的输出目录。</p> <p>如果你将 <code>MyApp</code> 的根目录添加到环境变量 <code>classpath</code> 中或者将 <code>MyApp/target/</code> 目录添加到系统属性 <code>java.class.path</code> 中，那么运行时就可以加载这些路径下的类库。</p> <p>假设 <code>Main.java</code> 中的代码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>myapp</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span></span><span class="token class-name">ExampleClass</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 使用自定义的 ExampleClass</span>
        <span class="token class-name">ExampleClass</span> example <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExampleClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> example<span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 使用第三方库的方法</span>
        <span class="token class-name">String</span> text <span class="token operator">=</span> <span class="token string">&quot;Hello, World!&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> reversed <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Result: &quot;</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Reversed Text: &quot;</span> <span class="token operator">+</span> reversed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>在这个例子中，<code>Main</code> 类中使用了自定义的 <code>ExampleClass</code> 类以及第三方库 <code>StringUtils</code> 的方法。如果 <code>MyApp</code> 的根目录或 <code>MyApp/target/</code> 目录已经被加入到环境变量 <code>classpath</code> 中或系统属性 <code>java.class.path</code> 中，那么在运行 <code>Main</code> 类时，Java 虚拟机就会在这些路径下查找并加载所需的类库。</p> <ul><li>该类加载是程序中<code>默认的类加载器</code>，一般来说，<code>Java应用的类</code>都是由它来完成<code>加载</code></li> <li>通过ClassLoader#getSystemclassLoader() 方法可以获取到该类加载器</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SystemClassLoaderExample</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ClassLoader</span> systemClassLoader <span class="token operator">=</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 输出系统类加载器的名称</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;System Class Loader: &quot;</span> <span class="token operator">+</span> systemClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 尝试加载一个类，查看其类加载器</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> exampleClass <span class="token operator">=</span> systemClassLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">&quot;com.example.ExampleClass&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ClassLoader</span> classLoader <span class="token operator">=</span> exampleClass<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Class Loaded by: &quot;</span> <span class="token operator">+</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Class not found.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><img src="https://gitee.com/studentgitee/note-picture/raw/master/image-20230812112927272.png" alt="image-20230812112927272"></p> <h4 id="用户自定义类加载器"><a href="#用户自定义类加载器" class="header-anchor">#</a> 用户自定义类加载器</h4> <p>在Java的日常应用程序开发中，类的加载几乎是由上述3种类加载器相互配合执行的，在必要时，我们还可以自定义类加载器，来定制类的加载方式。 为什么要自定义类加载器？</p> <ul><li><p>隔离加载类</p></li> <li><p>修改类加载的方式</p></li> <li><p>扩展加载源</p></li> <li><p>防止源码泄漏</p></li></ul> <p>用户自定义类加载器实现步骤：</p> <ol><li><p>继承 <code>java.lang.ClassLoader</code> 类： 创建一个新的类，继承自 <code>java.lang.ClassLoader</code>，作为自定义类加载器的基类。</p></li> <li><p>重写 <code>findClass</code> 方法： 在自定义类加载器中，需要重写 <code>findClass</code> 方法。该方法负责根据类的名称查找类的字节码并加载。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException {
    // 在这里实现查找并加载类的逻辑，返回字节码的字节数组
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>加载类字节码： 在 <code>findClass</code> 方法中，实现根据类名称加载类的字节码。可以从文件、数据库、网络等位置获取类的字节码数据。</p></li> <li><p>调用 <code>defineClass</code> 方法： 在 <code>findClass</code> 方法中，通过 <code>defineClass</code> 方法将字节码转换成 <code>Class</code> 对象并返回。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>byte[] classBytes = ...; // 从文件或其他位置加载类的字节码数据
return defineClass(name, classBytes, 0, classBytes.length);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>设置类加载的父加载器： 自定义类加载器可以选择指定父加载器。如果没有显式指定父类加载器，则会默认使用创建该类加载器的类的类加载器作为其父类加载器。</p></li> <li><p>实例化自定义类加载器： 在应用中实例化自定义类加载器，通常需要传入父类加载器和其他必要的参数。</p></li> <li><p>使用自定义类加载器加载类： 使用自定义类加载器加载需要的类。可以通过 <code>loadClass</code> 方法来加载类，也可以通过创建类的实例来使用。</p></li> <li><p>注意资源加载： 自定义类加载器还需要实现加载类所需的其他资源，如配置文件、属性文件等。</p></li></ol> <p>下面是一个简单的示例代码，演示了如何创建一个自定义类加载器并使用它加载一个类：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> classPath<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">CustomClassLoader</span><span class="token punctuation">(</span><span class="token class-name">String</span> classPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>classPath <span class="token operator">=</span> classPath<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">findClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 读取类字节码数据</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classBytes <span class="token operator">=</span> <span class="token function">loadClassBytes</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 使用 defineClass 方法加载类</span>
            <span class="token keyword">return</span> <span class="token function">defineClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> classBytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> classBytes<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to load class &quot;</span> <span class="token operator">+</span> name<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">loadClassBytes</span><span class="token punctuation">(</span><span class="token class-name">String</span> className<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> fileName <span class="token operator">=</span> className<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token char">'.'</span><span class="token punctuation">,</span> <span class="token char">'/'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.class&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">FileInputStream</span> fis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>classPath <span class="token operator">+</span> fileName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>fis<span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            fis<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> buffer<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">InstantiationException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 自定义类加载器加载指定目录下的类</span>
        <span class="token class-name">String</span> classPath <span class="token operator">=</span> <span class="token string">&quot;path/to/your/classes/&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">CustomClassLoader</span> customClassLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomClassLoader</span><span class="token punctuation">(</span>classPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 加载并实例化一个类</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> loadedClass <span class="token operator">=</span> customClassLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">&quot;com.example.MyClass&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> instance <span class="token operator">=</span> loadedClass<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 调用类的方法</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token keyword">instanceof</span> <span class="token class-name">MyClass</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">MyClass</span> myInstance <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MyClass</span><span class="token punctuation">)</span> instance<span class="token punctuation">;</span>
            myInstance<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><p>上面的示例代码中，<code>CustomClassLoader</code> 继承了 <code>ClassLoader</code> 类，重写了 <code>findClass</code> 方法，实现了自定义的类加载逻辑。在 <code>main</code> 方法中，我们创建了一个自定义类加载器实例，使用它加载并实例化了一个类，并调用了类的方法。</p> <h3 id="classloader的api"><a href="#classloader的api" class="header-anchor">#</a> ClassLoader的API</h3> <table><thead><tr><th style="text-align:center;">API</th> <th style="text-align:center;">说明</th></tr></thead> <tbody><tr><td style="text-align:center;">getParent()</td> <td style="text-align:center;">获取上一级的类加载器</td></tr> <tr><td style="text-align:center;">loadClass(String name)</td> <td style="text-align:center;">加载名称为name的类，返回的是一个Class实例，在此方法中会间接调用findClass方法</td></tr> <tr><td style="text-align:center;">findClass(String name)</td> <td style="text-align:center;">加载名称为name的类，返回的是一个Class实例。通常自定义类加载器时，会重写此方法。</td></tr> <tr><td style="text-align:center;">findLoadedClass（String name）</td> <td style="text-align:center;">检查名称为name的Class是否已经加载过，返回的是一个Class实例，如果Class为null，就表示未加载，否则就是已经加载</td></tr> <tr><td style="text-align:center;">defineClass(String name, byte[] b, int off, int len)</td> <td style="text-align:center;">将字节数组b的二进制数据转换成Java中的Class对象</td></tr> <tr><td style="text-align:center;">resolveClass(Class c)</td> <td style="text-align:center;">解析并连接到指定的Class</td></tr></tbody></table> <h3 id="双亲委派机制"><a href="#双亲委派机制" class="header-anchor">#</a> 双亲委派机制</h3> <p>Java虚拟机对class文件采用的是按需加载的方式，也就是说当需要使用该类时才会将它的class文件加载到内存生成class对象。而且加载某个类的class文件时，Java虚拟机采用的是双亲委派模式，即把请求交由父类处理，它是一种任务委派模式。</p> <h4 id="工作原理"><a href="#工作原理" class="header-anchor">#</a> 工作原理</h4> <ul><li><p>1）如果一个类加载器收到了类加载请求，<code>它并不会自己先去加载</code>，而是把这个请求<code>委托给父类的加载器</code>去执行；</p></li> <li><p>2）如果父类加载器还存在其父类加载器，则进一步向上委托，依次递归，请求最终将到达顶层的启动类加载器；</p></li> <li><p>3）如果父类加载器可以完成类加载任务，就成功返回，倘若父类加载器无法完成此加载任务，子加载器才会尝试自己去加载，这就是双亲委派模式。</p></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">synchronized</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resolve<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 首先，检查请求的类是否已经被加载过了</span>
        <span class="token class-name">Class</span> c <span class="token operator">=</span> <span class="token function">findLoadedClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    c <span class="token operator">=</span> parent<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    c <span class="token operator">=</span> <span class="token function">findBootstrapClassOrNull</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果父类加载器抛出ClassNotFoundException</span>
            <span class="token comment">// 说明父类加载器无法完成加载请求</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 在父类加载器无法加载时</span>
            <span class="token comment">// 再调用本身的findClass方法来进行类加载</span>
                c <span class="token operator">=</span> <span class="token function">findClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果 resolve 参数为 true，会尝试解析该类，即连接类，执行其静态初始化。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">resolveClass</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h4 id="好处"><a href="#好处" class="header-anchor">#</a> 好处</h4> <p><code>双亲委派很好地解决了各个类加载器协作时基础类型的一致性问题（越基础的类由越上层的加载器进行加载）</code></p> <p>使用双亲委派模型来组织类加载器之间的关系，一个显而易见的好处就是Java中的类随着它的类加载器一起具备了一种带有优先级的层次关系。</p> <p>例如类java.lang.Object，它存放在rt.jar之中，无论哪一个类加载器要加载这个类，最终都是委派给处于模型最顶端的启动类加载器进行加载，因此Object类在程序的各种类加载器环境中都能够保证是同一个类。</p> <p>反之，如果没有使用双亲委派模型，都由各个类加载器自行去加载的话，如果用户自己也编写了一个名为java.lang.Object的类，并放在程序的ClassPath中，那系统中就会出现多个不同的Object类，Java类型体系中最基础的行为也就无从保证，应用程序将会变得一片混乱。</p> <p>下面是一个简单的示例代码，演示了使用双亲委派模型加载Object类的过程：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassLoaderExample</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取系统类加载器</span>
        <span class="token class-name">ClassLoader</span> systemClassLoader <span class="token operator">=</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 使用系统类加载器加载Object类</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> objectClass <span class="token operator">=</span> systemClassLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.Object&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// 输出加载的Object类信息</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Loaded Object class: &quot;</span> <span class="token operator">+</span> objectClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Object class loader: &quot;</span> <span class="token operator">+</span> objectClass<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>输出结果：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Loaded Object class: class java.lang.Object
Object class loader: null
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在这个示例中，我们使用系统类加载器加载了Object类。由于Object类是Java标准库中的核心类，它由引导类加载器加载。因此，Object类的类加载器为null。</p> <p>这个示例展示了双亲委派模型的好处，无论是使用系统类加载器还是自定义的应用类加载器，加载的都是同一个Object类，保证了Java类型体系的一致性。</p> <h4 id="jndi"><a href="#jndi" class="header-anchor">#</a> JNDI</h4> <p>JNDI(Java Naming and Directory Interface)是一个应用程序设计的 API，一种标准的 Java 命名系统接口。JNDI 提供统一的客户端 API，通过不同的访问提供者接口JNDI服务供应接口(SPI)的实现，由管理者将 JNDI API 映射为特定的命名服务和目录系统，使得 Java 应用程序可以和这些命名服务和目录服务之间进行交互。</p> <p>上面较官方说法，通俗的说就是若程序定义了 JDNI 中的接口，则就可以通过该接口 API 访问系统的 <code>命令服务</code>和<code>目录服务</code>,如下图。</p> <p><img src="https://gitee.com/studentgitee/note-picture/raw/master/image-20230812121846779.png" alt="image-20230812121846779"></p> <table><thead><tr><th style="text-align:center;">协议</th> <th style="text-align:center;">作用</th></tr></thead> <tbody><tr><td style="text-align:center;">LDAP</td> <td style="text-align:center;">轻量级目录访问协议，约定了 Client 与 Server 之间的信息交互格式、使用的端口号、认证方式等内容</td></tr> <tr><td style="text-align:center;">RMI</td> <td style="text-align:center;">JAVA 远程方法协议，该协议用于远程调用应用程序编程接口，使客户机上运行的程序可以调用远程服务器的对象</td></tr> <tr><td style="text-align:center;">DNS</td> <td style="text-align:center;">域名服务</td></tr> <tr><td style="text-align:center;">CORBA</td> <td style="text-align:center;">公共对象请求代理体系结构</td></tr></tbody></table> <h4 id="spi"><a href="#spi" class="header-anchor">#</a> SPI</h4> <p>SPI（Service Provider Interface）机制是 Java 提供的一种服务发现机制，用于实现组件之间的解耦和扩展。它允许不同模块提供接口的实现，而不需要在代码中显式指定实现类，从而实现了在运行时动态加载、替换和扩展组件的能力。</p> <p>SPI 机制的基本思想是，接口的实现由具体的服务提供者来定义，而服务的使用者通过服务加载器在运行时动态地发现和加载这些实现。SPI 机制通常涉及三个角色：</p> <ol><li><strong>服务接口（Service Interface）</strong>：定义一组方法或规范，表示某一种功能或服务。通常由 API 模块提供，由服务的使用者调用。</li> <li><strong>服务提供者（Service Provider）</strong>：实现了服务接口的具体类。服务提供者通过在 JAR 文件的 <code>META-INF/services</code> 目录下创建一个以服务接口全限定名命名的文件，内容为实现类的全限定名，从而让服务加载器能够发现并加载这些实现。</li> <li><strong>服务加载器（Service Loader）</strong>：是 Java 标准库提供的工具类，用于加载服务提供者的实现。它会根据服务接口的全限定名在类路径下搜索符合条件的实现类，并将它们加载到内存中。</li></ol> <p>SPI 机制的优点在于，它实现了松耦合和可插拔性，允许开发者在不修改代码的情况下更换或扩展功能。典型的应用场景包括数据库驱动加载、日志框架的适配、各种扩展插件等。</p> <p><strong>例子</strong></p> <p>JDBC 使用 SPI 机制来加载和注册数据库驱动程序。JDBC 规范定义了 <code>java.sql.Driver</code> 接口，数据库驱动程序需要实现这个接口。JDBC 的服务加载器会在类路径下搜索并加载这些实现类，从而实现数据库驱动的加载和管理。</p> <p><strong>驱动加载</strong>：在应用程序中，使用 <code>Class.forName()</code> 方法加载特定的数据库驱动类，这个类的加载会触发对应的驱动实现的静态代码块，从而将驱动注册到 JDBC 驱动管理器。</p> <p>下面是一个简单的示例，演示了如何使用 SPI 机制加载数据库驱动：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Connection</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">DriverManager</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JDBCExample</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 加载 MySQL 驱动</span>
        <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;com.mysql.cj.jdbc.Driver&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取数据库连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token string">&quot;jdbc:mysql://localhost:3306/mydb&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;username&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 使用连接进行数据库操作...</span>

        <span class="token comment">// 关闭连接</span>
        connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><code>DriverManager</code>（也就是上面的服务加载器） 是 JDBC 提供的一个类，用于管理和维护数据库驱动程序的注册和连接。虽然在概念上可以将其理解为一种绑定关系的载体，但更准确地说，它是一个连接数据库和获取数据库连接的中介。</p> <p>在 JDBC 中，每个数据库驱动都实现了 <code>java.sql.Driver</code> 接口，这些驱动在加载时会通过静态代码块将自己注册到 <code>DriverManager</code> 中。当应用程序需要与数据库建立连接时，<code>DriverManager</code> 负责根据给定的连接字符串（URL）选择合适的驱动程序，然后使用该驱动程序创建数据库连接。</p> <p>理解 <code>DriverManager</code> 的角色可以类比为一个中介或者调度员：</p> <ol><li><strong>驱动注册</strong>：每个数据库驱动都会通过静态代码块将自己注册到 <code>DriverManager</code> 中，这样 <code>DriverManager</code> 就知道有哪些数据库驱动可用。</li> <li><strong>连接选择和创建</strong>：当应用程序需要连接数据库时，它会通过 <code>DriverManager</code> 提供的 <code>getConnection()</code> 方法传递一个数据库连接字符串（URL）。<code>DriverManager</code> 会遍历已注册的驱动程序，找到合适的驱动程序来处理这个连接请求，然后由该驱动程序创建数据库连接。</li> <li><strong>连接池管理</strong>：<code>DriverManager</code> 可以管理多个数据库连接，使连接的管理更加简单。它可以从连接池中分配连接给应用程序，以及在连接不再需要时将其释放回连接池。</li></ol> <p>虽然 <code>DriverManager</code> 可以被理解为一种绑定关系的载体，但它更多地是一个协调者和管理者，负责协调不同的数据库驱动，确保应用程序能够方便地与数据库进行交互。它提供了一种标准化的方式来获取数据库连接，减少了对不同数据库的驱动细节的依赖。</p> <h4 id="自定义spi接口"><a href="#自定义spi接口" class="header-anchor">#</a> 自定义SPI接口</h4> <p>首先，我们创建一个服务接口 <code>MyService</code>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MyService</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>然后，创建两个不同的服务提供者实现类，分别命名为 <code>MyServiceImpl1</code> 和 <code>MyServiceImpl2</code>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyServiceImpl1</span> <span class="token keyword">implements</span> <span class="token class-name">MyService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Service Implementation 1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyServiceImpl2</span> <span class="token keyword">implements</span> <span class="token class-name">MyService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Service Implementation 2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>⚠️小贴士：</strong></p> <blockquote><p>在 IntelliJ IDEA 中创建的项目，默认情况下是没有 <code>META-INF</code> 目录的，因为 <code>META-INF</code> 通常是用来放置一些配置文件或描述文件的。如果你需要在项目中使用 <code>META-INF</code> 目录，可以按照以下步骤进行操作：</p> <ol><li>在源代码目录下创建一个新的目录，命名为 <code>resources</code>（如果项目中已经有了 <code>resources</code> 目录，可以直接使用它）。</li> <li>在 <code>resources</code> 目录下创建一个新的目录，命名为 <code>META-INF</code>。</li> <li>在<code>META-INF</code>目录创建一个新的目录，命名为<code>services</code></li> <li>在 <code>services</code> 目录下创建一个以服务接口的全限定名命名的文件，例如 <code>com.example.MyService</code>。</li> <li>在文件中写入对应的服务提供者实现类的全限定名，每行一个。</li></ol></blockquote> <p>接下来，为每个服务提供者实现类创建一个描述文件，放在 <code>META-INF/services</code> 目录下，文件名为服务接口的全限定名（<code>com.example.MyService</code>），内容为对应的服务提供者实现类的全限定名：</p> <p><code>META-INF/services/com.example.MyService</code>：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>com.example.MyServiceImpl1
com.example.MyServiceImpl2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>最后，我们可以编写客户端代码来动态加载并使用这些服务提供者：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ServiceLoader</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ServiceLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MyService</span><span class="token punctuation">&gt;</span></span> serviceLoader <span class="token operator">=</span> <span class="token class-name">ServiceLoader</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">MyService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MyService</span> service <span class="token operator">:</span> serviceLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            service<span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>在这个示例中，<code>ServiceLoader.load(MyService.class)</code> 会加载并实例化 <code>META-INF/services/com.example.MyService</code> 文件中列出的所有服务提供者实现类。然后，我们遍历服务提供者实现的迭代器，并调用它们的 <code>doSomething()</code> 方法。</p> <p>这就是 SPI 机制的基本原理和用法。通过描述文件和服务加载器，我们能够轻松地为一个接口定义的服务提供多个实现，并在运行时动态选择和使用这些实现。</p> <h4 id="spi源码解析"><a href="#spi源码解析" class="header-anchor">#</a> SPI源码解析</h4> <p><img src="https://gitee.com/studentgitee/note-picture/raw/master/image-20230814181225744.png" alt="image-20230814181225744"></p> <p><strong>流程总结∶</strong><code>找到配置文件，解析配置文件，然后反射获取对象，放入缓存</code></p> <p>ServiceLoader 类的全局变量：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//spi 默认加载的路径</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PREFIX</span> <span class="token operator">=</span> <span class="token string">&quot;META-INF/services/&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 表示正在被加载的类或接口</span>
<span class="token comment">// The class or interface representing the service being loaded</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> service<span class="token punctuation">;</span>

<span class="token comment">// 用于定位、装入和实例化提供程序的类加载器</span>
<span class="token comment">// The class loader used to locate, load, and instantiate providers</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ClassLoader</span> loader<span class="token punctuation">;</span>

<span class="token comment">// 权限控制上下文</span>
<span class="token comment">// The access control context taken when the ServiceLoader is created</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AccessControlContext</span> acc<span class="token punctuation">;</span>

<span class="token comment">// 基于实例的顺序缓存类的实现实例，其中Key为实现类的全限定类名</span>
<span class="token comment">// Cached providers, in instantiation order</span>
<span class="token keyword">private</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> providers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 当前的&quot;懒查找&quot;迭代器，ServiceLoader的核心</span>
<span class="token comment">// The current lazy-lookup iterator</span>
<span class="token keyword">private</span> <span class="token class-name">LazyIterator</span> lookupIterator<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>ServiceLoader.load(Search.class) 加载入口：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">ServiceLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取当前线程的类加载器</span>
    <span class="token class-name">ClassLoader</span> cl <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">return</span> <span class="token class-name">ServiceLoader</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">ServiceLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> service<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> loader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 因为 ServiceLoader 的构造为私有，这里只能依赖此静态方法来访问私有构造实例化，典型的静态工厂方法。</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ServiceLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> loader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">ServiceLoader</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> svc<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> cl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// svc 为 null,抛 NullPointerException</span>
    service <span class="token operator">=</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>svc<span class="token punctuation">,</span> <span class="token string">&quot;Service interface cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 若没有指定加载器，默认使用系统加载器</span>
    loader <span class="token operator">=</span> <span class="token punctuation">(</span>cl <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> cl<span class="token punctuation">;</span>
    <span class="token comment">// Java安全管理器  </span>
    acc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 清空实例化好的缓存。</span>
    providers<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &quot;懒查找&quot;，ServiceLoader 的核心。</span>
    lookupIterator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LazyIterator</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> loader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>LazyIterator 为 ServiceLoader 的核心，来看看具体源码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">LazyIterator</span> <span class="token keyword">implements</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> service<span class="token punctuation">;</span>
    <span class="token class-name">ClassLoader</span> loader<span class="token punctuation">;</span>
    <span class="token comment">// 加载资源的URL集合</span>
    <span class="token class-name">Enumeration</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> configs <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> 
    <span class="token comment">// 需加载的实现类的全限定类名的集合</span>
    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> pending <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 下一个需要加载的实现类的全限定类名</span>
    <span class="token class-name">String</span> nextName <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">LazyIterator</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> service<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> loader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>service <span class="token operator">=</span> service<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>loader <span class="token operator">=</span> loader<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">hasNextService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//资源已存在，无需加载</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextName <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 资源为null,尝试加载</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>configs <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 资源名称，META-INF/services + 全限定名</span>
                <span class="token class-name">String</span> fullName <span class="token operator">=</span> <span class="token constant">PREFIX</span> <span class="token operator">+</span> service<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>loader <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    configs <span class="token operator">=</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemResources</span><span class="token punctuation">(</span>fullName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span>
                    configs <span class="token operator">=</span> loader<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span>fullName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">fail</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> <span class="token string">&quot;Error locating configuration files&quot;</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 从资源中解析出需要加载的所有实现类的全限定类名</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pending <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>pending<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>configs<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            pending <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> configs<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 下一个需要加载的实现类的全限定类名</span>
        nextName <span class="token operator">=</span> pending<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token class-name">S</span> <span class="token function">nextService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasNextService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> cn <span class="token operator">=</span> nextName<span class="token punctuation">;</span>
        nextName <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> c <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 反射构造 Class 实例</span>
            c <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>cn<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> loader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fail</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> <span class="token string">&quot;Provider &quot;</span> <span class="token operator">+</span> cn <span class="token operator">+</span> <span class="token string">&quot; not found&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 类型判断，校验实现类必须与当前加载的类/接口的关系是派生或相同，否则抛出异常终止</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>service<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fail</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> <span class="token string">&quot;Provider &quot;</span> <span class="token operator">+</span> cn  <span class="token operator">+</span> <span class="token string">&quot; not a subtype&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 实例并强转</span>
            <span class="token class-name">S</span> p <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 实例完成，添加缓存，Key：实现类全限定类名，Value：实现类实例</span>
            providers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cn<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> p<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fail</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> <span class="token string">&quot;Provider &quot;</span> <span class="token operator">+</span> cn <span class="token operator">+</span> <span class="token string">&quot; could not be instantiated&quot;</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// This cannot happen</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 判断在 SPI 机制下是否还有下一个可用的实现类</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 检查 acc（AccessControlContext）是否为 null</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>acc <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果为 null，表示当前线程没有特殊的权限上下文。这通常在常规代码执行中发生。</span>
            <span class="token keyword">return</span> <span class="token function">hasNextService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果不为 null，则表示当前线程拥有特殊的权限上下文，可能是由 doPrivileged 方法设置的</span>
            <span class="token comment">// 如果 acc 不为 null，则创建一个 PrivilegedAction 对象。</span>
            <span class="token comment">// PrivilegedAction 是一个接口，它的 run() 方法封装了一段具有特殊权限的代码块。</span>
            <span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> action <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 在 PrivilegedAction 的 run() 方法中，调用 hasNextService() 方法来判断是否有下一个实现类。</span>
                <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">hasNextService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token comment">// 这里使用AccessController.doPrivileged(action, acc) 来执行 run() 方法，</span>
            <span class="token comment">// 确保这段代码拥有特殊的权限上下文 acc。</span>
            <span class="token keyword">return</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> acc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">S</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>acc <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">nextService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> action <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">public</span> <span class="token class-name">S</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">nextService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> acc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br></div></div><p><strong>LazyIterator 机制总结</strong>：LazyIterator 也实现了 Iterator接口的实现，Lazy特性体现在只有在使用 ServiceLoader 调用 iterator() 方法获取 Iterator 接口匿名实现类后， 再调用 hasNext() 方法时，才会&quot;懒判断&quot;或者&quot;懒加载&quot;下一个实现类的实例。</p> <p>❓ 看到这里可能有同学有疑问，nextService()方法中，为什么要通过Class.forName(cn, false, loader);来进行创建实例呢？我们不可以直接new一个出来吗？</p> <p>比如上面自定义SPI接口中的<code>MyServiceImpl1</code>和<code>MyServiceImpl2</code>，我可不可以直接像下面这段代码一样进行创建实例呢？</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">MyServiceImpl1</span> myServiceImpl1<span class="token punctuation">;</span>
<span class="token class-name">MyServiceImpl2</span> myServiceImpl2<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>className<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;MyServiceImpl1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    myServiceImpl1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyServiceImpl1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>className<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;MyServiceImpl2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    myServiceImpl2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyServiceImpl2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><blockquote><p>答案是不可以的。</p> <p>结论∶核心类或者ext包下的类里面是不能new普通对象的。而普通类里面是可以new出核心包和ext包里的对象的。</p></blockquote> <p>❓ 这里其实还有一个比较重要的点，就是为什么它要用这个<code>Class&lt;?&gt; forName(String name, boolean initialize,ClassLoader loader)</code>方法创建实例，而不是用<code>Class&lt;?&gt; forName(String className)</code>这个方法创建实例呢？</p> <p>是这样的，如果使用<code>Class&lt;?&gt; forName(String className)</code>，我们可以先看一下这个方法的源码</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@CallerSensitive</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">forName</span><span class="token punctuation">(</span><span class="token class-name">String</span> className<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
     <span class="token comment">// 获取调用者的类加载器</span>
     <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> caller <span class="token operator">=</span> <span class="token class-name">Reflection</span><span class="token punctuation">.</span><span class="token function">getCallerClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> <span class="token function">forName0</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span><span class="token punctuation">,</span> caller<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>Class&lt;?&gt; caller = Reflection.getCallerClass();</code>是获取调用者的类加载器，那么现在我们调用者是ServiceLoader，他是<code>引导类加载器（Bootstrap ClassLoader）</code>加载的，所以就算我们拿到<code>引导类加载器（Bootstrap ClassLoader）</code>，也是不行的，因为它只负责加载核心类（只加载<code>JAVA_HOME/jre/lib/rt.jar</code>目录下的），但是<code>MyServiceImpl1</code>和<code>MyServiceImpl1</code>并不是核心类，而我们其实是想让<code>应用程序类加载器（AppClassLoader）</code>加载的，所以不能用这个方法。</p> <p>❓ 那为什么使用<code>Class&lt;?&gt; forName(String name, boolean initialize,ClassLoader loader)</code>就可以呢，是因为这个方法可以通过指定类加载器的方式去加载类。而这个类加载器我们可以通过线程上下文类加载器（Thread Context ClassLoader）获取到，一般来说就是<code>应用程序类加载器（AppClassLoader）</code>。</p> <p>❓ 其实Class.forName后面还是走的双亲委派机制加载的，但是必须在第一步先打破双亲委派，打破的本质就是<code>让发起方变成App类加载器</code>，否则你的发起方就是<code>Bootstrap类加载器，没法向下委托的</code>。</p> <p><strong>我们再看下 iterator() 的 Iterator 匿名实现类源码：</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> knownProviders <span class="token operator">=</span> providers<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>knownProviders<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> lookupIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token class-name">S</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>knownProviders<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token keyword">return</span> knownProviders<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> lookupIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>调用链分析完，最后看下 hasNextService 中解析限定名文件的 parse 方法，主要检查文件内容的字符合法性、缓存过滤避免重复加载。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> service<span class="token punctuation">,</span> <span class="token class-name">URL</span> u<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServiceConfigurationError</span> <span class="token punctuation">{</span>
    <span class="token class-name">InputStream</span> in <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">BufferedReader</span> r <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 存放 META-INF/services 下文件中的实现类的全类名</span>
    <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> names <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        in <span class="token operator">=</span> u<span class="token punctuation">.</span><span class="token function">openStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>in<span class="token punctuation">,</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> lc <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>lc <span class="token operator">=</span> <span class="token function">parseLine</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> u<span class="token punctuation">,</span> r<span class="token punctuation">,</span> lc<span class="token punctuation">,</span> names<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fail</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> <span class="token string">&quot;Error reading configuration file&quot;</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> r<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>in <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fail</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> <span class="token string">&quot;Error closing configuration file&quot;</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 解析完返回迭代器</span>
    <span class="token keyword">return</span> names<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//具体解析资源文件中每一行内容</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">parseLine</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> service<span class="token punctuation">,</span> <span class="token class-name">URL</span> u<span class="token punctuation">,</span> <span class="token class-name">BufferedReader</span> r<span class="token punctuation">,</span> <span class="token keyword">int</span> lc<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> names<span class="token punctuation">)</span> 
        <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServiceConfigurationError</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> ln <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ln <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment">//-1表示解析完成</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果存在'#'字符，截取第一个'#'字符串之前的内容，'#'字符之后的属于注释内容</span>
    <span class="token keyword">int</span> ci <span class="token operator">=</span> ln<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token char">'#'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ci <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> ln <span class="token operator">=</span> ln<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> ci<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ln <span class="token operator">=</span> ln<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> n <span class="token operator">=</span> ln<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//不合法的标识：' '、'\t'</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ln<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token char">' '</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>ln<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token char">'\t'</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">fail</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> u<span class="token punctuation">,</span> lc<span class="token punctuation">,</span> <span class="token string">&quot;Illegal configuration-file syntax&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> cp <span class="token operator">=</span> ln<span class="token punctuation">.</span><span class="token function">codePointAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//判断第一个 char 是否一个合法的 Java 起始标识符</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">isJavaIdentifierStart</span><span class="token punctuation">(</span>cp<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">fail</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> u<span class="token punctuation">,</span> lc<span class="token punctuation">,</span> <span class="token string">&quot;Illegal provider-class name: &quot;</span> <span class="token operator">+</span> ln<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//判断所有其他字符串是否属于合法的Java标识符</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">charCount</span><span class="token punctuation">(</span>cp<span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">charCount</span><span class="token punctuation">(</span>cp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cp <span class="token operator">=</span> ln<span class="token punctuation">.</span><span class="token function">codePointAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">isJavaIdentifierPart</span><span class="token punctuation">(</span>cp<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>cp <span class="token operator">!=</span> <span class="token char">'.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token function">fail</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> u<span class="token punctuation">,</span> lc<span class="token punctuation">,</span> <span class="token string">&quot;Illegal provider-class name: &quot;</span> <span class="token operator">+</span> ln<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//不存在则缓存</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>providers<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>names<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">)</span> names<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> lc <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><h4 id="spi打破双亲委派机制"><a href="#spi打破双亲委派机制" class="header-anchor">#</a> SPI打破双亲委派机制</h4> <p>基础类型之所以被称为<code>基础</code>，是因为它们总是作为被用户代码继承、调用的API存在，但程序设计往往没有绝对不变的完美规则，如果有基础类型又要调用回用户的代码，那该怎么办呢？比如ServiceLoader中要调用SPI实现的代码，而SPI实现的代码可能是用户的代码。</p> <p>这并非是不可能出现的事情，一个典型的例子便是JNDI(Java Naming and Directory Interface)服务，<code>JNDI现在已经是Java的标准服务</code>，<code>它的代码由启动类加载器来完成加载（在JDK 1.3时加入到rt.jar的）</code>，肯定属于Java中很基础的类型了。但JNDI存在的目的就是对资源进行查找和集中管理，它需要调用由其他厂商实现并部署在应用程序的ClassPath下的JNDI服务提供者接口（Service Provider Interface，SPI）的代码，现在问题来了，<code>启动类加载器是绝不可能认识、加载这些代码的</code>，那该怎么办❓</p> <p>大白话解释：类加载原来是这样的，用户自定义的代码是<code>应用程序类加载器（AppClassLoader）</code>加载的，JDK的安装目录的<code>jre/lib/ext</code>子目录（扩展目录）是<code>扩展类加载器（Extension ClassLoader）</code>加载的，核心类是由<code>引导类加载器（Bootstrap ClassLoader）</code>加载的，但是现在我要打破这种机制，我想让引导类加载器加载用户自定义的类。</p> <h4 id="jdbc举例"><a href="#jdbc举例" class="header-anchor">#</a> <strong>JDBC举例</strong></h4> <p><strong>架构</strong></p> <p><img src="https://gitee.com/studentgitee/note-picture/raw/master/image-20230812122203924.png" alt="image-20230812122203924"></p> <p>当我们加载jdbc.jar 用于实现数据库连接的时候，首先我们需要知道的是 jdbc.jar是基于SPI接口进行实现的，所以在加载的时候，会进行双亲委派，最终从根加载器中加载 SPI核心类（用于管理SPI接口和实现类的类），然后在加载SPI接口类（定义了一组服务接口的类，它是供实现类实现的），接着在进行反向委派，通过线程上下文类加载器进行实现类jdbc.jar的加载。</p> <p><img src="https://gitee.com/studentgitee/note-picture/raw/master/image-20230812131846893.png" alt="image-20230812131846893"></p> <p>SPI核心类和SPI接口是由系统类加载器加载的，而SPI接口的实现类是由具体的应用类加载器加载的。具体的加载过程如下：</p> <ol><li>SPI核心类和SPI接口位于Java的标准库中，因此它们是由系统类加载器加载的。</li> <li>当应用程序使用SPI机制时，它会在类路径下查找META-INF/services目录，并读取其中的配置文件。</li> <li>配置文件中列出了SPI接口的实现类的全限定名。</li> <li>当应用程序需要使用某个SPI接口时，它会通过系统类加载器加载该接口的实现类。</li></ol> <p>总结：<code>SPI核心类和SPI接口由系统类加载器加载，而SPI接口的实现类由具体的应用类加载器加载</code>。</p> <h3 id="其他"><a href="#其他" class="header-anchor">#</a> 其他</h3> <h4 id="如何判断两个class对象是否相同"><a href="#如何判断两个class对象是否相同" class="header-anchor">#</a> <strong>如何判断两个class对象是否相同</strong></h4> <p>在JVM中表示两个class对象是否为同一个类存在两个必要条件：</p> <ul><li><p>类的完整类名必须一致，包括包名。</p></li> <li><p>加载这个类的ClassLoader（指ClassLoader实例对象）必须相同。</p></li></ul> <p>换句话说，在JVM中，即使这两个类对象（class对象）来源同一个Class文件，被同一个虚拟机所加载，但只要加载它们的ClassLoader实例对象不同，那么这两个类对象也是不相等的。</p> <h4 id="对类加载器的引用"><a href="#对类加载器的引用" class="header-anchor">#</a> <strong>对类加载器的引用</strong></h4> <p>JVM必须知道一个类型是由启动加载器加载的还是由用户类加载器加载的。如果一个类型是由用户类加载器加载的，那么JVM会将这个类加载器的一个引用作为类型信息的一部分保存在方法区中。当解析一个类型到另一个类型的引用的时候，JVM需要保证这两个类型的类加载器是相同的。</p> <h4 id="类的主动使用和被动使用"><a href="#类的主动使用和被动使用" class="header-anchor">#</a> <strong>类的主动使用和被动使用</strong></h4> <p>Java程序对类的使用方式分为：主动使用和被动使用。</p> <p>主动使用，又分为七种情况：</p> <ul><li><p>创建类的实例</p></li> <li><p>访问某个类或接口的静态变量，或者对该静态变量赋值</p></li> <li><p>调用类的静态方法</p></li> <li><p>反射（比如：Class.forName（&quot;com.classloader.Test&quot;））</p></li> <li><p>初始化一个类的子类</p></li> <li><p>Java虚拟机启动时被标明为启动类的类</p></li> <li><p>JDK 7 开始提供的动态语言支持：
java.lang.invoke.MethodHandle实例的解析结果
REF_getStatic、REF_putStatic、REF_invokeStatic句柄对应的类没有初始化，则初始化</p></li></ul> <p>除了以上七种情况，其他使用Java类的方式都被看作是对类的被动使用，都不会导致类的初始化。</p></div></div>  <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2024/01/25, 17:13:40</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/00e30d/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">JVM与Java体系结构</div></a> <a href="/pages/2898db/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">运行时数据区</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/00e30d/" class="prev">JVM与Java体系结构</a></span> <span class="next"><a href="/pages/2898db/">运行时数据区</a>→
      </span></p></div></div></div> <!----></main></div> <div class="footer"><!----> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2023-2024
    <span>Gping | MIT License</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.57e44612.js" defer></script><script src="/assets/js/2.ea24d1ee.js" defer></script><script src="/assets/js/18.3bb48241.js" defer></script>
  </body>
</html>
